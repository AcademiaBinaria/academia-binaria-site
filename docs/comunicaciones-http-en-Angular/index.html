<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"><title>Comunicaciones http en Angular | Academia Binaria</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Las comunicaciones http son una pieza fundamental del desarrollo web, y en Angular siempre han sido fáciles y potentes. ¿Siempre?, bueno cuando apareció Angular 2 echábamos en falta algunas cosillas,"><meta name="keywords" content="Angular2,Tutorial,http,Angular,Angular5,Introducción,Angular6,Observables"><meta property="og:type" content="article"><meta property="og:title" content="Comunicaciones http en Angular"><meta property="og:url" content="https://academia-binaria.com/comunicaciones-http-en-Angular/index.html"><meta property="og:site_name" content="Academia Binaria"><meta property="og:description" content="Las comunicaciones http son una pieza fundamental del desarrollo web, y en Angular siempre han sido fáciles y potentes. ¿Siempre?, bueno cuando apareció Angular 2 echábamos en falta algunas cosillas,"><meta property="og:locale" content="es"><meta property="og:image" content="https://academia-binaria.com/css/images/angular-6_http.png"><meta property="og:updated_time" content="2018-09-14T10:12:30.747Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Comunicaciones http en Angular"><meta name="twitter:description" content="Las comunicaciones http son una pieza fundamental del desarrollo web, y en Angular siempre han sido fáciles y potentes. ¿Siempre?, bueno cuando apareció Angular 2 echábamos en falta algunas cosillas,"><meta name="twitter:image" content="https://academia-binaria.com/css/images/angular-6_http.png"><link rel="alternate" href="http://eepurl.com/b3p7fb" title="Academia Binaria" type="application/atom+xml"><link rel="icon" href="/css/images/favicon.ico"><link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/libs/open-sans/styles.css"><link rel="stylesheet" href="/libs/source-code-pro/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/libs/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript">!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-66674029-1","auto"),ga("send","pageview")</script></head></html><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><i class="logo"></i> <span class="site-title">Academia Binaria</span></a><nav id="main-nav"><a class="main-nav-link" href="/tag/Angular">Angular</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"><a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/c6ea942080cef8be6ff80ca095e718b8"> <i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form class="search-form"><input type="text" class="ins-search-input search-form-input" placeholder="Buscar"> <button type="submit" class="search-form-submit"></button></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="escribe..."> <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Entradas",PAGES:"Páginas",CATEGORIES:"Categorias",TAGS:"Etiquetas",UNTITLED:"(Untitled)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script></div></div></div><div id="main-nav-mobile" class="header-sub header-inner"><table class="menu outer"><tr><td><a class="main-nav-link" href="/tag/Angular">Angular</a></td><td><div class="search-form"><input type="text" class="ins-search-input search-form-input" placeholder="Buscar"></div></td></tr></table></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"><img id="avatar" src="https://www.gravatar.com/avatar/c6ea942080cef8be6ff80ca095e718b8?s=128"><h2 id="name">Alberto Basalo</h2><h3 id="title">Formador y Consultor</h3><span id="location"><i class="fa fa-map-marker"></i>A Coruña, Spain</span> <a id="follow" target="_blank" href="https://twitter.com/albertobasalo">SEGUIR</a></div><div class="article-info profile-block"><div class="article-info-block"><a target="_blank" href="http://atlanticbootcamp.com">Atlantic</a></div><div class="article-info-block"><a target="_blank" href="http://agorabinaria.com">Ágora</a></div></div><div class="profile-block social-links"><table><tr><td><a href="https://github.com/AcademiaBinaria" target="_blank" title="github" class="tooltip"><i class="fa fa-github"></i></a></td><td><a href="https://twitter.com/albertobasalo" target="_blank" title="twitter" class="tooltip"><i class="fa fa-twitter"></i></a></td><td><a href="https://www.facebook.com/Agora.Binaria.SL/" target="_blank" title="facebook" class="tooltip"><i class="fa fa-facebook"></i></a></td><td><a href="http://eepurl.com/b3p7fb" target="_blank" title="rss" class="tooltip"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-comunicaciones-http-en-Angular" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">Comunicaciones http en Angular</h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/comunicaciones-http-en-Angular/"><time datetime="2018-09-14T09:06:00.000Z" itemprop="datePublished">14-09-2018</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></div><div class="article-tag"><i class="fa fa-tag"></i> <a class="tag-link" href="/tag/Angular/">Angular</a>, <a class="tag-link" href="/tag/Angular2/">Angular2</a>, <a class="tag-link" href="/tag/Angular5/">Angular5</a>, <a class="tag-link" href="/tag/Angular6/">Angular6</a>, <a class="tag-link" href="/tag/Introduccion/">Introducción</a>, <a class="tag-link" href="/tag/Observables/">Observables</a>, <a class="tag-link" href="/tag/Tutorial/">Tutorial</a>, <a class="tag-link" href="/tag/http/">http</a></div></div></header><div class="article-entry" itemprop="articleBody"><p><img src="/images/tutorial-angular-6_http.png" alt="Tutorial Angular5 6-http"></p><p>Las comunicaciones <em>http</em> son una pieza fundamental del desarrollo web, y en <strong>Angular</strong> siempre han sido fáciles y potentes. ¿Siempre?, bueno cuando apareció Angular 2 echábamos en falta algunas cosillas, y la librería <em>RxJs</em> y sus <em>streams</em> son intimidantes.</p><p>Pero con la versión 6 <strong>consumir un servicio REST</strong> puede ser cosa de niños si aprendes a jugar con los <em>observables</em> y los servicios de la librería <code>@angular/common/http</code>. Conseguirás realizar <strong>comunicaciones asíncronas en Angular 6</strong>.</p><a id="more"></a><p>Partiendo de la aplicación tal cómo quedó en <a href="../servicios-inyectables-en-Angular/">Servicios inyectables en Angular</a>. Al finalizar tendrás una aplicación que almacena y recupera los datos consumiendo un servicio REST.</p><blockquote><p>Código asociado a este artículo en <em>GitHub</em>: <a href="https://github.com/AcademiaBinaria/angular5/tree/master/6-http/cash-flow" target="_blank" rel="noopener">AcademiaBinaria/AutoBot/6-http</a></p><blockquote><p>Tienes una versión desplegada operativa para probar <a href="https://academiabinaria.github.io/autobot/" target="_blank" rel="noopener">AutoBot</a></p></blockquote></blockquote><h1 id="1-El-servicio-HttpClient"><a href="#1-El-servicio-HttpClient" class="headerlink" title="1. El servicio HttpClient"></a>1. El servicio HttpClient</h1><p>La librería <code>@angular/common/http</code> trae el módulo <code>HttpClientModule</code> con el servicio inyectable <code>HttpClient</code> que debes declarar como dependencia en tus propios constructores.</p><p>En tu código tienes que reclamar la dependencia para poder usarla. Queda algo así:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CarsService &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>A partir de este momento sólo queda invocar los métodos REST en la propiedad <code>this.http</code>.</p><h2 id="1-1-Metodos-REST"><a href="#1-1-Metodos-REST" class="headerlink" title="1.1 Métodos REST"></a>1.1 Métodos REST</h2><p>Para cada verbo <em>http</em> tenemos su método en el servicio <code>HttpClient</code>. Su primer parámetro será la <em>url</em> a la que invocar. Los métodos de envío reciben la carga en el segundo argumento, y la envían automáticamente como objetos <em>JSON</em>.</p><p>Veamos un ejemplo sencillo para montar un <em>CRUD</em> de cualquier cosa, coches por ejemplo. He usado una notación similar al <em>SQL</em> para ilustrar lo que se espera de los comandos.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> selectCars$(): Observable&lt;Car[]&gt; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.http.get&lt;Car[]&gt;(<span class="string">'https://autobot.com/api/cars/'</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> selectCar$(carId: <span class="built_in">string</span>): Observable&lt;Car&gt; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.http.get&lt;Car&gt;(<span class="string">'https://autobot.com/api/cars/'</span> + carId);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> insertCar$(car: Car): Observable&lt;car&gt; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.http.post&lt;Car&gt;(<span class="string">'https://autobot.com/api/cars/'</span>, car);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">public</span> updateCar$(car: Car): Observable&lt;car&gt; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.http.put&lt;Car&gt;(<span class="string">'https://autobot.com/api/cars/'</span> + car._id, car);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> deleteCar$(operation: Operation): Observable&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.http.delete(<span class="string">'https://autobot.com/api/cars/'</span> + car._id);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><blockquote><p>Cada método de negocio, configura la llamada de infraestructura; parece poca cosa. Podría ser un buen sitio para validar la información antes de ser enviada, o quizás agrupar varias llamadas de red para una misma operación de negocio. El <em>dolar</em> al final del nombre es un convenio para las funciones que devuelven observables.</p></blockquote><p>El consumo de este servicio en su versión más básica sería algo así:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CarsComponent &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> cars: CarsService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> ngOnInit()&#123;</span><br><span class="line">    <span class="keyword">this</span>.cars.selectCars$()</span><br><span class="line">      .susbcribe(</span><br><span class="line">        cars =&gt; <span class="built_in">console</span>.log(<span class="string">'I have '</span> + cars.lenght + <span class="string">' cars.'</span>),</span><br><span class="line">        err =&gt; <span class="built_in">console</span>.error(<span class="string">'There was an error: '</span> + err.message)</span><br><span class="line">      )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>El método de nuestro servicio nos devuelve un observable de los datos de la respuesta <em>http</em>. Es un <em>stream</em> de un sólo suceso pero al que alguien debe subscribirse. En la susbcripción asignamos funciones <em>callback</em>. La primera se ejecutará al recibir los datos. La segunda en caso de que haya un error.</p><p>Y hasta aquí lo básico de comunicaciones <em>http</em>. ¿Fácil verdad?. Pero la vida real raramente es tan sencilla. Si quieres enfrentarte a algo más duro debes prepararte y dominar los observables <em>RxJs</em>. Pero eso ya no será <em>your grandpa´s http anymore</em>.</p><h1 id="2-Observables"><a href="#2-Observables" class="headerlink" title="2 Observables"></a>2 Observables</h1><p>Las <strong>comunicaciones</strong> entre navegadores y servidores son varios órdenes de magnitud más lentas que las operaciones en memoria. Por tanto deben realizarse de manera asíncrona para garantizar una buena experiencia al usuario.</p><p>Esta experiencia no siempre fue tan buena para el programador. Sobre todo con las primeras comunicaciones <em>AJAX</em> basadas en el paso de funciones <em>callback</em>. La aparición de las <em>promises</em> mejoró la claridad del código, y ahora con los <em>Observables</em> tenemos además una gran potencia para manipular la <strong>información asíncrona</strong>.</p><blockquote><p>El patrón <code>Observable</code> fue implementado por Microsoft en la librería <a href="http://reactivex.io/intro.html" target="_blank" rel="noopener"><em>Reactive Extensions</em></a> más conocida como <code>RxJs</code>. El equipo de Angular decidió utilizarla para el desarrollo de las comunicaciones asíncronas. Esta extensa librería puede resultar intimidante en un primer vistazo. Pero con muy poco conocimiento puedes programar casi todas las funcionalidades que se te ocurran.</p></blockquote><p>Lo primero es importar el código, esto se hace forma similar a cualquier otra clase o función. Para empezar basta con <code>import { Observable } from &quot;rxjs/Observable&quot;;</code>.</p><p>Esta es una clase genérica donde sus instancias admiten la manipulación interna de tipos más o menos concretos. Por eso ves en el ejemplo que algunas funciones retornan <code>: Observable&lt;Car&gt;</code>, o si no saben que tipo esperar se conforman con <code>: Observable&lt;any&gt;</code>.</p><p>En cualquier caso, <strong>toda operación asíncrona retornará una instancia observable</strong> a la cual habrá que subscribirse para recibir los datos o los errores, cuando termine. Por limpieza eso debes hacerlo en los componentes que consuman el servicio, no en el propio servicio.</p><h2 id="2-1-Lectura"><a href="#2-1-Lectura" class="headerlink" title="2.1 Lectura"></a>2.1 Lectura</h2><p>En <code>HomeComponent</code> tenemos un ejemplo sencillo para empezar con el consumo de observables. En una llamda al servicio obtemos como resultado un Observable. Pero mira el código relevante y verás que las cosas cambian:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> HomeComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  <span class="keyword">public</span> carLinks$: Observable&lt;Link[]&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> cars: CarsService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> ngOnInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.carLinks$ = <span class="keyword">this</span>.cars.getCars$().pipe(map(<span class="function"><span class="params">cars</span> =&gt;</span> cars.map(<span class="keyword">this</span>.getLinkFromCar)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> getLinkFromCar(car: Car): Link &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      caption: car.link.caption,</span><br><span class="line">      routerLink: <span class="string">'/car/'</span> + car.link.routerLink,</span><br><span class="line">      value: formatNumber(car.cost, <span class="string">'en-US'</span>) + <span class="string">' EUR'</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-1-1-Pipe"><a href="#2-1-1-Pipe" class="headerlink" title="2.1.1 Pipe"></a>2.1.1 Pipe</h2><p>Los datos devueltos raramente vienen en el formato preciso para usar en la vista. Con frecuencia hay que transformarlos al vuelo en cuanto se reciben. Recordemos que <em>HttpClient</em> no devuelve los datos tal cual sino un <em>stream</em> de estados de dichos datos. La manipulación será sobre el <em>stream</em> no direactamente sobre los datos y para manipular un torrente hay que encauzarlo en tuberías.</p><p>Aquí es donde aparece el método <code>.pipe(operator1, operator2...)</code> aplicado a un observable, en luagar o antes de <code>.susbcribe(okCallback, errCallback)</code>. Este método entuba una serie de operadores predefinidos que manipulan el chorro de estados observados.</p><p>El operador más utilizado es <code>map(source =&gt; target)</code>.</p><h2 id="2-1-2-Async"><a href="#2-1-2-Async" class="headerlink" title="2.1.2 Async"></a>2.1.2 Async</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-menu-list</span> <span class="attr">caption</span>=<span class="string">"Cars in your garage:"</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">links</span>]=<span class="string">"carLinks$ | async"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">app-menu-list</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>Recordatorio para novatos: Es importante comprender la naturaleza asíncrona de estas operaciones. El código de las funciones subscritas se ejecutará en el futuro, no de una manera secuencial.</p></blockquote><h2 id="2-2-Escritura"><a href="#2-2-Escritura" class="headerlink" title="2.2 Escritura"></a>2.2 Escritura</h2><p>Si lo que quieres es enviar objetos a un servidor, por ejemplo mediante el verbo <em>POST</em>, sólo tienes que pasarle la <em>payload</em> al método de negocio y suscribirte a la respuesta.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> saveOperation(operation: Operation) &#123;</span><br><span class="line"> <span class="keyword">this</span>.operationsService</span><br><span class="line">   .saveOperation$(operation)</span><br><span class="line">   .subscribe(<span class="function"><span class="params">data</span> =&gt;</span> <span class="keyword">this</span>.refreshData());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>De nuevo, fíjate como refrescamos los datos una vez recibida la respuesta. Hacerlo antes podría dar lugar a respuestas incongruentes. En este caso no es la respuesta en sí lo que interesa, sino el hecho de haya terminado bien.</p></blockquote><h1 id="3-Interceptores"><a href="#3-Interceptores" class="headerlink" title="3 Interceptores"></a>3 Interceptores</h1><p>Angular ha incorporado recientemente el concepto de interceptor que había funcionado muy bien en <em>AngularJS</em>. Ahora los interceptores son clases con métodos que interceptan (de ahí su nombre) todas las peticiones http realizadas. En esos métodos puedes poner lógica que modifique, cancele o simplemente controle el ciclo petición/respuesta de cada llamada.</p><h2 id="3-1-Implementacion-de-la-interfaz"><a href="#3-1-Implementacion-de-la-interfaz" class="headerlink" title="3.1 Implementación de la interfaz"></a>3.1 Implementación de la interfaz</h2><p>Aprovechando el <strong>TypeScript</strong> y sus características de programación orientada a objetos, en <strong>Angular</strong> han optado por obligarnos a cumplir <em>interfaces</em> y como contraparte al cumplir ese contrato invocan a nuestro código en circunstancias controladas. ¿Cómo se hace?.</p><p>Para empezar hay que crear un servicio inyectable en un módulo general o en el raíz. Yo he creado el <code>CatchInterceptorService</code> en <code>lib/catch-interceptor.service.ts</code>. Ten a mano <a href="https://github.com/AcademiaBinaria/angular5/blob/master/6-http/cash-flow/src/app/lib/catch-interceptor.service.ts" target="_blank" rel="noopener">este enlace</a> para seguir el retos del artículo. Su propósito será capturar las respuestas y gestionar de forma centralizada los errores que se obtengan en un único lugar. Como cualquier otro inyectable habrá que proveerlo en un módulo, yo lo hice en el raíz. Si abres el <code>app.module.ts</code> verás un sistema de aprovisionamiento algo complejo.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  &#123;</span><br><span class="line">    provide: HTTP_INTERCEPTORS,</span><br><span class="line">    useClass: CatchInterceptorService,</span><br><span class="line">    multi: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>La dependencia que se solicitará es <code>HTTP_INTERCEPTORS</code>, y cuando alguien lo haga (son los servicios de http de Angular a bajo nivel) le será inyectada una instancia de la clase <code>CatchInterceptorService</code>.</p><blockquote><p>Es decir, tu clase interceptora será usada sin que el que la reclame conozca siquiera su nombre. Pero esto es la clave de la inversión de control en la inyección de dependencias.</p></blockquote><p>El parámetro <code>multi: true</code>, indica que puedes crear tantas clases de interceptación como quieras. Esto permite tener múltiples interceptores especializados.</p><h2 id="3-2-El-metodo-de-interceptacion"><a href="#3-2-El-metodo-de-interceptacion" class="headerlink" title="3.2 El método de interceptación"></a>3.2 El método de interceptación</h2><p>Al implementar la interfaz <code>HttpInterceptor</code> estás obligado a crear un método con una firma como esta: <code>public intercept(req, next)</code>. Este será invocado para cada llamada que hecha con <code>httpClient</code>. A esta función se la conoce como <em>función interceptora</em> y ya ves que tiene unos argumentos y un tipo de retorno bien definidos… y algo complejos a primera vista. Veamos una implementación mínimalista.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> intercept(req: HttpRequest&lt;<span class="built_in">any</span>&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> next.handle(req);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Lo que dice es que recibe un puntero a la petición en curso, <code>req: HttpRequest&lt;any&gt;</code>, y otro a la siguiente clase que la procese,<code>next: HttpHandler</code>. También obliga a devolver un observable; lógico porque esto es en último término a lo que te suscribes en tu código de negocio. Afortunadamente el método <code>handle(req: HttpRequest&lt;any&gt;)</code> de cualquiera que sea la siguiente clase procesadora retorna un observable. Y así se da continuidad al flujo de la llamada.</p><h2 id="3-3-Los-operadores-observables"><a href="#3-3-Los-operadores-observables" class="headerlink" title="3.3 Los operadores observables"></a>3.3 Los operadores observables</h2><p>Además de tipos de datos como <code>Observable&lt;any&gt;</code> con métodos clave como <code>.subscribe(ok, err, end)</code>, la librería <em>RxJs</em> viene cargadita de <a href="http://reactivex.io/documentation/operators.html" target="_blank" rel="noopener">operadores</a> que… operan sobre instancias de los observables. Esos operadores son funciones que reciben y retornan observables.</p><p>Podemos ver a los observables como <em>streams</em>, es decir una corriente de datos que circula por una tubería. Los operadores serán funciones que afecten al contenido o al caudal y que se pueden agregar o eliminar ordenadamente de la tubería. Una de esas operaciones se llama <code>tap</code>, un grifo.</p><blockquote><p>Nota: este operador fue anteriormente conocido como <code>do</code>.<a href="http://reactivex.io/documentation/operators/do.html" target="_blank" rel="noopener">Ver documentación operador do</a>.</p></blockquote><p>La operación <code>tap</code> se usa cuando se quiere actuar ante un cambio en el contenido o caudal pero sin cambiarlo. Para mi es adecuada porque lo que pretendo es auditar las llamadas y enterarme de los errores sin tocar absolutamente nada.</p><p>En base a todo lo anterior montaré unas sentencias como estas dentro de la función <code>intercept</code>:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handledRequest = next.handle(req);</span><br><span class="line"><span class="keyword">const</span> successCallback = <span class="keyword">this</span>.interceptResponse.bind(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">const</span> errorCallback = <span class="keyword">this</span>.catchError.bind(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">const</span> interceptionOperator = tap&lt;HttpEvent&lt;<span class="built_in">any</span>&gt;&gt;(</span><br><span class="line">  successCallback,</span><br><span class="line">  errorCallback</span><br><span class="line">);</span><br><span class="line"><span class="keyword">return</span> handledRequest.pipe(interceptionOperator);</span><br></pre></td></tr></table></figure><p>Tómate tu tiempo para revisar cada línea. En primer lugar obtengo un puntero al <em>stream observable</em> que es la petición en curso. Despues asigno dos funciones locales que actuarán como <em>callbacks</em> para cuando lleguen datos o errores respectivamente. Preparo el operador <code>tap</code> de la librería observable asignádole ambos <em>callbacks</em> y un tipo de retorno concreto en su genérico. Y por último mediante el método <code>pipe</code> engancho el operador a la tubería por la que circula el chorro. Respira y vuelve a leerlo.</p><blockquote><p>Admito que si es tu primer contacto con este mundo de los observables este codigo pueda resultar complejo. La buena noticia es que este código es una especie de patrón o <em>snippet</em> que puedes reutiliazar para casi cualquier interceptor. Sólo habrá que cambiar el operador y el trabajo interno de sus <em>callbacks</em>.</p></blockquote><p>Con esto tienes un sistema que envía a la consola información extra como la duración de las llamadas. Además inspecciona los errores en un único lugar. Esto puede incluso hacer innecesario que los componentes procesen errores.</p><p>Ya tenemos los datos almacenados en un servidor con el que nos comunicamos por <em>http</em>; aunque por ahora de forma anónima. Con el conocimiento actual de los observables, el <em>httpClient</em> y los interceptores estamos a un paso de darle seguridad a las comunicaciones. Sigue esta serie para añadirle <a href="../vigilancia-y-seguridad-en-Angular/">vigilancia y seguridad en Angular</a> mientras aprendes a programar con Angular6.</p><blockquote><p>Aprender, programar, disfrutar, repetir.<br>– <cite>Saludos, Alberto Basalo</cite></p></blockquote></div><footer class="article-footer"><div class="share-container"></div><a data-url="https://academia-binaria.com/comunicaciones-http-en-Angular/" data-id="cjbrwpvin001ziwd3551c6s4a" class="article-share-link"><i class="fa fa-share"></i>Compartir</a><script>!function(n){"undefined"!=typeof __SHARE_BUTTON_BINDED__&&__SHARE_BUTTON_BINDED__||(__SHARE_BUTTON_BINDED__=!0,n("body").on("click",function(){n(".article-share-box.on").removeClass("on")}).on("click",".article-share-link",function(t){t.stopPropagation();var e,a=n(this),o=a.attr("data-url"),i=encodeURIComponent(o),r="article-share-box-"+a.attr("data-id"),s=a.offset();if(n("#"+r).length){if((e=n("#"+r)).hasClass("on"))return void e.removeClass("on")}else{var l=['<div id="'+r+'" class="article-share-box">','<input class="article-share-input" value="'+o+'">','<div class="article-share-links">','<a href="https://twitter.com/intent/tweet?url='+i+'" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>','<a href="https://www.facebook.com/sharer.php?u='+i+'" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>','<a href="http://pinterest.com/pin/create/button/?url='+i+'" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>','<a href="https://plus.google.com/share?url='+i+'" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',"</div>","</div>"].join("");e=n(l),n("body").append(e)}n(".article-share-box.on").hide(),e.css({top:s.top+25,left:s.left}).addClass("on")}).on("click",".article-share-box",function(t){t.stopPropagation()}).on("click",".article-share-box-input",function(){n(this).select()}).on("click",".article-share-box-link",function(t){t.preventDefault(),t.stopPropagation(),window.open(this.href,"article-share-box-window-"+Date.now(),"width=500,height=450")}))}(jQuery)</script><a href="https://academia-binaria.com/comunicaciones-http-en-Angular/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://academia-binaria.com/comunicaciones-http-en-Angular/">Comentarios</a></footer></div><nav id="article-nav"><a href="/servicios-inyectables-en-Angular/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Antiguo</strong><div class="article-nav-title">Servicios inyectables en Angular</div></a></nav></article><section id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Recientes</h3><div class="widget"><ul id="recent-post"><li><div class="item-thumbnail"><a href="/comunicaciones-http-en-Angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-6_http.png)" alt="Comunicaciones http en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/comunicaciones-http-en-Angular/" class="title">Comunicaciones http en Angular</a></p><p class="item-date"><time datetime="2018-09-14T09:06:00.000Z" itemprop="datePublished">14-09-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/servicios-inyectables-en-Angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-5_inject.png)" alt="Servicios inyectables en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/servicios-inyectables-en-Angular/" class="title">Servicios inyectables en Angular</a></p><p class="item-date"><time datetime="2018-09-11T08:44:58.000Z" itemprop="datePublished">11-09-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/flujo-de-datos-entre-componentes-angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-4_flow.png)" alt="Flujo de datos entre componentes Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/flujo-de-datos-entre-componentes-angular/" class="title">Flujo de datos entre componentes Angular</a></p><p class="item-date"><time datetime="2018-09-06T15:10:44.000Z" itemprop="datePublished">06-09-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/formularios-tablas-y-modelos-de-datos-en-angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-3_data.png)" alt="Formularios, tablas y modelos de datos en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/formularios-tablas-y-modelos-de-datos-en-angular/" class="title">Formularios, tablas y modelos de datos en Angular</a></p><p class="item-date"><time datetime="2018-08-29T17:17:37.000Z" itemprop="datePublished">29-08-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/paginas-y-rutas-angular-spa/" class="thumbnail"><span style="background-image:url(/css/images/angular-2_spa.png)" alt="Páginas y rutas Angular SPA" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/paginas-y-rutas-angular-spa/" class="title">Páginas y rutas Angular SPA</a></p><p class="item-date"><time datetime="2018-08-24T10:19:14.000Z" itemprop="datePublished">24-08-2018</time></p></div></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Categorias</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Avanzado/">Avanzado</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Introduccion/">Introducción</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Opinion/">Opinión</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tutorial/">Tutorial</a><span class="category-list-count">9</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Tutorial/Angular/">Angular</a><span class="category-list-count">9</span></li></ul></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Nube de etiquetas</h3><div class="widget tagcloud"><a href="/tag/Angular/" style="font-size:17.14px">Angular</a> <a href="/tag/Angular2/" style="font-size:20px">Angular2</a> <a href="/tag/Angular5/" style="font-size:17.14px">Angular5</a> <a href="/tag/Angular6/" style="font-size:15.71px">Angular6</a> <a href="/tag/AngularJS/" style="font-size:12.86px">AngularJS</a> <a href="/tag/BackEnd/" style="font-size:10px">BackEnd</a> <a href="/tag/Bootstrap/" style="font-size:11.43px">Bootstrap</a> <a href="/tag/CLI/" style="font-size:14.29px">CLI</a> <a href="/tag/Components/" style="font-size:10px">Components</a> <a href="/tag/DI/" style="font-size:11.43px">DI</a> <a href="/tag/Forms/" style="font-size:12.86px">Forms</a> <a href="/tag/FrontEnd/" style="font-size:10px">FrontEnd</a> <a href="/tag/Introduccion/" style="font-size:17.14px">Introducción</a> <a href="/tag/MongoDB/" style="font-size:11.43px">MongoDB</a> <a href="/tag/NodeJS/" style="font-size:14.29px">NodeJS</a> <a href="/tag/Observables/" style="font-size:10px">Observables</a> <a href="/tag/Routing/" style="font-size:10px">Routing</a> <a href="/tag/SPA/" style="font-size:11.43px">SPA</a> <a href="/tag/Servicios/" style="font-size:10px">Servicios</a> <a href="/tag/Tutorial/" style="font-size:18.57px">Tutorial</a> <a href="/tag/TypeScript/" style="font-size:10px">TypeScript</a> <a href="/tag/http/" style="font-size:11.43px">http</a> <a href="/tag/observables/" style="font-size:10px">observables</a> <a href="/tag/reactiveForms/" style="font-size:10px">reactiveForms</a></div></div><div class="widget-wrap widget-list"><h3 class="widget-title">Links</h3><div class="widget"><ul><li><a href="http://atlanticbootcamp.com">Atlantic Bootcamp</a></li><li><a href="http://agorabinaria.com">Ágora Binaria</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Archivos</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">septiembre 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">agosto 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">mayo 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">diciembre 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">marzo 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">septiembre 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">junio 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">mayo 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">abril 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">marzo 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">enero 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">noviembre 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">agosto 2015</a><span class="archive-list-count">4</span></li></ul></div></div><div id="toTop" class="fa fa-angle-up"></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2018 Developed by <a target="_blank" href="http://agorabinaria.com">Ágora Binaria</a>.</div></div></footer><script>var disqus_config=function(){this.page.url="https://academia-binaria.com/comunicaciones-http-en-Angular/",this.page.identifier="comunicaciones-http-en-Angular"};!function(){var a=document,e=a.createElement("script");e.src="//academiabinaria.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(a.head||a.body).appendChild(e)}()</script><script src="/js/main.js"></script><script src="//load.sumome.com/" data-sumo-site-id="24f3eb649e85fa1f7db20b7fa344f42f381f65f8f86f7028766c55d313e73eb5" async></script></div></body>