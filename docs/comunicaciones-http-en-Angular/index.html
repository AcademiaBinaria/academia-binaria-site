<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"><title>Comunicaciones http en Angular | Academia Binaria</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Las comunicaciones http son una pieza fundamental del desarrollo web, y en Angular siempre han sido fáciles y potentes. ¿Siempre?, bueno cuando apareció Angular 2 echábamos en falta algunas cosillas…"><meta name="keywords" content="Angular2,Tutorial,http,Angular,Angular5,Introducción,Angular6,Observables,RxJS"><meta property="og:type" content="article"><meta property="og:title" content="Comunicaciones http en Angular"><meta property="og:url" content="https://academia-binaria.com/comunicaciones-http-en-Angular/index.html"><meta property="og:site_name" content="Academia Binaria"><meta property="og:description" content="Las comunicaciones http son una pieza fundamental del desarrollo web, y en Angular siempre han sido fáciles y potentes. ¿Siempre?, bueno cuando apareció Angular 2 echábamos en falta algunas cosillas…"><meta property="og:locale" content="es"><meta property="og:image" content="https://academia-binaria.com/css/images/angular-6_http.png"><meta property="og:updated_time" content="2018-09-20T07:49:21.647Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Comunicaciones http en Angular"><meta name="twitter:description" content="Las comunicaciones http son una pieza fundamental del desarrollo web, y en Angular siempre han sido fáciles y potentes. ¿Siempre?, bueno cuando apareció Angular 2 echábamos en falta algunas cosillas…"><meta name="twitter:image" content="https://academia-binaria.com/css/images/angular-6_http.png"><link rel="alternate" href="http://eepurl.com/b3p7fb" title="Academia Binaria" type="application/atom+xml"><link rel="icon" href="/css/images/favicon.ico"><link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/libs/open-sans/styles.css"><link rel="stylesheet" href="/libs/source-code-pro/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/libs/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript">!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-66674029-1","auto"),ga("send","pageview")</script></head></html><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><i class="logo"></i> <span class="site-title">Academia Binaria</span></a><nav id="main-nav"><a class="main-nav-link" href="/tag/Angular">Tutorial para aprender Angular</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"><a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/c6ea942080cef8be6ff80ca095e718b8"> <i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form class="search-form"><input type="text" class="ins-search-input search-form-input" placeholder="Buscar"> <button type="submit" class="search-form-submit"></button></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="escribe..."> <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Entradas",PAGES:"Páginas",CATEGORIES:"Categorias",TAGS:"Etiquetas",UNTITLED:"(Untitled)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script></div></div></div><div id="main-nav-mobile" class="header-sub header-inner"><table class="menu outer"><tr><td><a class="main-nav-link" href="/tag/Angular">Tutorial para aprender Angular</a></td><td><div class="search-form"><input type="text" class="ins-search-input search-form-input" placeholder="Buscar"></div></td></tr></table></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"><img id="avatar" src="https://www.gravatar.com/avatar/c6ea942080cef8be6ff80ca095e718b8?s=128"><h2 id="name">Alberto Basalo</h2><h3 id="title">Formador y Consultor</h3><span id="location"><i class="fa fa-map-marker"></i>A Coruña, Spain</span> <a id="follow" target="_blank" href="https://twitter.com/albertobasalo">SEGUIR</a></div><div class="article-info profile-block"><div class="article-info-block"><a target="_blank" href="http://atlanticbootcamp.com">Atlantic</a></div><div class="article-info-block"><a target="_blank" href="http://eepurl.com/b3p7fb">News</a></div></div><div class="profile-block social-links"><table><tr><td><a href="https://github.com/AcademiaBinaria" target="_blank" title="github" class="tooltip"><i class="fa fa-github"></i></a></td><td><a href="https://twitter.com/albertobasalo" target="_blank" title="twitter" class="tooltip"><i class="fa fa-twitter"></i></a></td><td><a href="https://www.facebook.com/Agora.Binaria.SL/" target="_blank" title="facebook" class="tooltip"><i class="fa fa-facebook"></i></a></td><td><a href="http://eepurl.com/b3p7fb" target="_blank" title="rss" class="tooltip"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-comunicaciones-http-en-Angular" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">Comunicaciones http en Angular</h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/comunicaciones-http-en-Angular/"><time datetime="2018-09-14T09:06:00.000Z" itemprop="datePublished">14-09-2018</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></div><div class="article-tag"><i class="fa fa-tag"></i> <a class="tag-link" href="/tag/Angular/">Angular</a>, <a class="tag-link" href="/tag/Angular2/">Angular2</a>, <a class="tag-link" href="/tag/Angular5/">Angular5</a>, <a class="tag-link" href="/tag/Angular6/">Angular6</a>, <a class="tag-link" href="/tag/Introduccion/">Introducción</a>, <a class="tag-link" href="/tag/Observables/">Observables</a>, <a class="tag-link" href="/tag/RxJS/">RxJS</a>, <a class="tag-link" href="/tag/Tutorial/">Tutorial</a>, <a class="tag-link" href="/tag/http/">http</a></div></div></header><div class="article-entry" itemprop="articleBody"><p><img src="/images/tutorial-angular-6_http.png" alt="comunicaciones-http-en-Angular"></p><p>Las comunicaciones <em>http</em> son una pieza fundamental del desarrollo web, y en <strong>Angular</strong> siempre han sido fáciles y potentes. ¿Siempre?, bueno cuando apareció Angular 2 echábamos en falta algunas cosillas… y la librería <em>RxJs</em> y sus <em>streams</em> son intimidantes para los novatos.</p><p>Pero con la versión Angular 6 <strong>consumir un servicio REST</strong> puede ser cosa de niños si aprendes a jugar con los <em>observables</em> y los servicios de la librería <code>@angular/common/http</code>. Conseguirás realizar <strong>comunicaciones http asíncronas en Angular 6</strong>.</p><a id="more"></a><p>Partiendo de la aplicación tal cómo quedó en <a href="../servicios-inyectables-en-Angular/">Servicios inyectables en Angular</a>. Al finalizar tendrás una aplicación que almacena y recupera los datos consumiendo un servicio REST usando las tecnologías de Angular Http.</p><blockquote><p>Código asociado a este artículo en <em>GitHub</em>: <a href="https://github.com/AcademiaBinaria/autobot/tree/6-http" target="_blank" rel="noopener">AcademiaBinaria/AutoBot/6-http</a></p><blockquote><p>Tienes una versión desplegada operativa para probar <a href="https://academiabinaria.github.io/autobot/" target="_blank" rel="noopener">AutoBot</a></p></blockquote></blockquote><h1 id="1-El-servicio-HttpClient"><a href="#1-El-servicio-HttpClient" class="headerlink" title="1. El servicio HttpClient"></a>1. El servicio HttpClient</h1><p>La librería <code>@angular/common/http</code> trae el módulo <code>HttpClientModule</code> con el servicio inyectable <code>HttpClient</code> que debes declarar como dependencia en tus propios constructores.</p><p>En tu código tienes que reclamar la dependencia para poder usarla. Atención a la importación pues hay más clases con el nombre <code>HttpClient</code>. Debe quedar algo así:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HttpClient &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CarsService &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>A partir de este momento sólo queda invocar los métodos REST en la propiedad <code>this.http</code>.</p><h2 id="1-1-Metodos-REST"><a href="#1-1-Metodos-REST" class="headerlink" title="1.1 Métodos REST"></a>1.1 Métodos REST</h2><p>Para cada verbo <em>http</em> tenemos su método en el servicio <code>HttpClient</code>. Su primer parámetro será la <em>url</em> a la que invocar. Los métodos de envío reciben la carga en el segundo argumento, y la envían automáticamente como objetos <em>JSON</em>.</p><p>Veamos un ejemplo sencillo para montar un <em>CRUD</em> de cualquier cosa, coches por ejemplo. He usado una notación similar al <em>SQL</em> para ilustrar lo que se espera de los comandos.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> url = <span class="string">'https://autobot.com/api/cars/'</span>;</span><br><span class="line"> <span class="keyword">public</span> selectCars$(): Observable&lt;Car[]&gt; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.http.get&lt;Car[]&gt;(<span class="keyword">this</span>.url);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> selectCar$(carId: <span class="built_in">string</span>): Observable&lt;Car&gt; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.http.get&lt;Car&gt;(<span class="keyword">this</span>.url + carId);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> insertCar$(car: Car): Observable&lt;car&gt; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.http.post&lt;Car&gt;(<span class="keyword">this</span>.url, car);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">public</span> updateCar$(car: Car): Observable&lt;car&gt; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.http.put&lt;Car&gt;(<span class="keyword">this</span>.url + car._id, car);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> deleteCar$(operation: Operation): Observable&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.http.delete(<span class="keyword">this</span>.url + car._id);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><blockquote><p>Cada método de negocio, configura la llamada de infraestructura; parece poca cosa. Podría ser un buen sitio para validar la información antes de ser enviada, o quizás agrupar varias llamadas de red para una misma operación de negocio. El <em>dolar</em> al final del nombre es un convenio para las funciones que devuelven observables.</p></blockquote><h2 id="1-2-Subscribe"><a href="#1-2-Subscribe" class="headerlink" title="1.2 Subscribe"></a>1.2 Subscribe</h2><p>Los observables http han de consumirse mediante el método subscribe para que realmente se lancen. Dicho método subscribe admite hasta tres callbacks: <code>susbcribe(data, err, end)</code> para que se ejecuten en respuesta a eventos. El consumo de este servicio en su versión más básica sería algo así:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CarsComponent &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> cars: CarsService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> ngOnInit()&#123;</span><br><span class="line">    <span class="keyword">this</span>.cars.selectCars$()</span><br><span class="line">      .susbcribe(</span><br><span class="line">        cars =&gt; <span class="built_in">console</span>.log(<span class="string">'Cars: '</span> + cars.lenght),</span><br><span class="line">        err =&gt; <span class="built_in">console</span>.error(<span class="string">'Ops: '</span> + err.message)</span><br><span class="line">      )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>El método de nuestro servicio nos devuelve <strong>un observable de los datos de la respuesta <em>http</em></strong>. Es un <em>stream</em> de un sólo suceso pero al que alguien debe subscribirse. En la susbcripción asignamos funciones <em>callback</em>. La primera se ejecutará al recibir los datos. La segunda en caso de que haya un error. El método <em>subscribe</em></p><p>Y hasta aquí lo básico de comunicaciones <em>http</em>. ¿Fácil verdad?. Pero la vida real raramente es tan sencilla. Si quieres enfrentarte a algo más duro debes prepararte y dominar los observables <em>RxJs</em>.</p><p>Lo que viene a partir de ahora requerirá tiempo y concentración. Si continúas adelante esto ya no será <em>your grandpa´s http anymore</em>.</p><h1 id="2-Observables"><a href="#2-Observables" class="headerlink" title="2 Observables"></a>2 Observables</h1><p>Las <strong>comunicaciones</strong> entre navegadores y servidores son varios órdenes de magnitud más lentas que las operaciones en memoria. Por tanto deben realizarse de manera asíncrona para garantizar una buena experiencia al usuario.</p><p>Esta experiencia no siempre fue tan buena para el programador. Sobre todo con las primeras comunicaciones <em>AJAX</em> basadas en el paso de funciones <em>callback</em>. La aparición de las <em>promises</em> mejoró la claridad del código, y ahora con los <em>Observables</em> tenemos además una gran potencia para manipular la <strong>información asíncrona</strong>.</p><blockquote><p>El patrón <code>Observable</code> fue implementado por Microsoft en la librería <a href="http://reactivex.io/intro.html" target="_blank" rel="noopener"><em>Reactive Extensions</em></a> más conocida como <code>RxJs</code>. El equipo de Angular decidió utilizarla para el desarrollo de las comunicaciones asíncronas. Esta extensa librería puede resultar intimidante en un primer vistazo. Pero con muy poco conocimiento puedes programar casi todas las funcionalidades que se te ocurran.</p></blockquote><p>Lo primero es importar el código, de forma similar a cualquier otra clase o función. Para empezar basta con <code>import { Observable } from &quot;rxjs/Observable&quot;;</code>. Tendremos la clase usada por angular para observar el respuesta <em>http</em>.</p><p>Pero esta es una clase genérica donde sus instancias admiten la manipulación interna de tipos más o menos concretos. Por eso ves en el ejemplo que algunas funciones retornan el tipo esperado <code>: Observable&lt;Car&gt;</code>, o si no saben que tipo esperar se conforman con <code>: Observable&lt;any&gt;</code>.</p><p>En cualquier caso, <strong>toda operación asíncrona retornará una instancia observable</strong> a la cual habrá que subscribirse para recibir los datos o los errores, cuando termine. Por limpieza eso debes hacerlo en los componentes que consuman el servicio, no en el propio servicio.</p><blockquote><p>El servicio, definie y manipula la instancia observable de la comunicación http. El componente recibe dicho observable que monitoriza la respuesta, se subscribe a ella y consume sus datos o errores.</p></blockquote><h2 id="2-1-Pipe"><a href="#2-1-Pipe" class="headerlink" title="2.1 Pipe"></a>2.1 Pipe</h2><p>En <code>HomeComponent</code> tenemos un ejemplo sencillo para empezar con el consumo de observables. En una llamada al servicio obtemos como resultado un Observable. Pero mira el código relevante y verás que las cosas cambian. Presta especial atención a los tipos de datos:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">'rxjs'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">'rxjs/operators'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> HomeComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  <span class="keyword">public</span> carLinks$: Observable&lt;Link[]&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> cars: CarsService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> ngOnInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.carLinks$ = </span><br><span class="line">      <span class="keyword">this</span>.cars.getCars$()</span><br><span class="line">      .pipe(</span><br><span class="line">        map(</span><br><span class="line">          (cars: Car[]): Link[] =&gt; </span><br><span class="line">            cars.map(<span class="keyword">this</span>.getLinkFromCar)</span><br><span class="line">        )</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> getLinkFromCar(car: Car): Link &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      caption: car.link.caption,</span><br><span class="line">      routerLink: <span class="string">'/car/'</span> + car.link.routerLink,</span><br><span class="line">      value: formatNumber(car.cost, <span class="string">'en-US'</span>) + <span class="string">' EUR'</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-1-1-El-operador-map"><a href="#2-1-1-El-operador-map" class="headerlink" title="2.1.1 El operador map"></a>2.1.1 El operador map</h2><p>Los datos devueltos raramente vienen en el formato preciso para usar en la vista. Con frecuencia hay que transformarlos al vuelo en cuanto se reciben. Recordemos que <strong><em>HttpClient</em> no devuelve los datos tal cual sino un <em>stream</em> de estados</strong> de dichos datos. La manipulación será sobre el <em>stream</em> no directamente sobre los datos; y, claro, para manipular un torrente hay que encauzarlo en tuberías.</p><p>Aquí es donde aparece el método <code>.pipe(operator1, operator2...)</code> aplicado a un observable, en lugar de, o antes de, <code>.susbcribe(okCallback, errCallback)</code>. Este método entuba una serie de operadores predefinidos que manipulan el chorro de estados observados.</p><p>El operador más utilizado es <code>map(sourceStream =&gt; targetStream)</code>. Este operador recibe una función <em>callBack</em> que será invocada ante cada dato recibido. Esa función tienen que retornar un valor para sustituir al actual y así transformar el contenido del chorro.</p><blockquote><p>En este caso partimos de un <em>array</em> de objetos de tipo <code>Car[]</code> y lo transformamos en otro array de tipo <code>Link[]</code>. Para ello, forzando un poco el ejercicio, he usado la función <code>.map(sourceElement =&gt; targetElement)</code> de los <em>arrays Javascript</em>. El conflicto es intencionado por mi parte para mostrar la coincidencia en nombre y propósito. Pero son artificios muy distintos; el operador <code>map</code> ha de importarse de <code>rxjs/operators</code> y aplicarse a un observable dentro de su método <code>.pipe()</code>, recibe y emite observables. Nada que ver con la sencilla función <code>array.map(callback)</code>, que recibe y devuelve datos estándar.</p></blockquote><h2 id="2-1-2-El-pipe-async"><a href="#2-1-2-El-pipe-async" class="headerlink" title="2.1.2 El pipe async"></a>2.1.2 El pipe async</h2><p>Siguiendo con las coincidencias en nombres que suelen causar confusión nos encontramos con el <em>pipe</em> <code>async</code>. En este caso es tecnología puramente Angular. En las vistas usamos <code>|</code> para trasnformar la representación de un dato mediante una función. En este caso, la función recibirá un observable y retornará su contenido… cuando llegue.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-menu-list</span> <span class="attr">caption</span>=<span class="string">"Cars in your garage:"</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">links</span>]=<span class="string">"carLinks$ | async"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">app-menu-list</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Este es el modo recomendado de consumo de observables en la vista. Hacerlo mediante el <em>pipe</em> <code>observable&lt;any&gt; | async</code> aporta múltiples ventajas que se irán viendo en este tutorial. Este <em>pipe</em> de Angular es una función que se subscribe al torrente recibido y devuelve sus estados concretos.</p><p>Se podría, pero <strong>no se recomienda</strong>, haber resuelto el tema de la siguiente manera:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  selector: <span class="string">'app-home'</span>,</span><br><span class="line">  template: <span class="string">`&lt;app-menu-list caption="Cars in your garage:" </span></span><br><span class="line"><span class="string">    [links]="carLinks"&gt;&lt;/app-menu-list&gt; `</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> HomeComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  <span class="keyword">public</span> carLinks: Link[];</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> cars: CarsService</span>) &#123;&#125;</span><br><span class="line">  <span class="keyword">public</span> ngOnInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.carLinks$ = <span class="keyword">this</span>.cars.getCars$()</span><br><span class="line">      .pipe(map(</span><br><span class="line">        (cars: Car[]): Link[] =&gt; cars.map(<span class="keyword">this</span>.getLinkFromCar)</span><br><span class="line">      ))</span><br><span class="line">      .subscribe(</span><br><span class="line">        (links: Link[]): <span class="function"><span class="params">void</span> =&gt;</span> <span class="keyword">this</span>.links= links;</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> getLinkFromCar(car: Car): Link &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      caption: car.link.caption,</span><br><span class="line">      routerLink: <span class="string">'/car/'</span> + car.link.routerLink,</span><br><span class="line">      value: formatNumber(car.cost, <span class="string">'en-US'</span>) + <span class="string">' EUR'</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Recordatorio para novatos asíncronos: Es importante comprender la naturaleza asíncrona de estas operaciones. El código de las funciones <em>callbacks</em> subscritas se ejecutará en el futuro, no de una manera secuencial.</p></blockquote><h2 id="2-2-Switch-Map"><a href="#2-2-Switch-Map" class="headerlink" title="2.2 Switch Map"></a>2.2 Switch Map</h2><p>Hemos visto como recuperar información asícrona y recibirla con un observable. Hemos aprendido a transformar los datos recibidos. Pero, ¿qué ocurre si lo que necesito para la transformación es otra llamada asíncrona?.</p><p>El operador <code>map()</code> trabaja con el contenido de un <em>stream</em>. Pero si queremos derivar el curso hacia otro arroyo necesitamos un operador más poderoso: el <code>switchMap()</code>.</p><p>Esta es una situación habitual cuando llamamos a un servicio y con su resultado futuro tenemos que llamar a otro. En realidad lo que queremos es el resultado del segundo observable, no el del primero. Para ello cambiamos al vuelo uno por otro; de ahí el <em>switch</em>.</p><p>En el <code>car.component.ts</code> tienes un ejemplo completo y complejo del entubado encadenado de operadores. Se trata de que al aplicación almacene y recupere los datos de viaje de cada coche, de forma que al cogerlo podamos continuar el viaje. Además del mencionado <code>switchMap</code> te presento también al sencillo <code>tap()</code>. Este operador se usa cuando queremos ejecutar instrucciones que no manipulen los datos del <em>stream</em>, pero que se efectúen cuando los datos lleguen. Es decir, <em>tap</em> usa el dato pero no lo transforma.</p><p>Analicemos el siguiente <em>snipet</em> linea a línea. Prestando una vez más especial atención a los tipos recibidos y devueltos por cada función.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ngOnInit() &#123;</span><br><span class="line">  <span class="keyword">this</span>.subscription: Subscription = <span class="keyword">this</span>.route.params</span><br><span class="line">    .pipe(</span><br><span class="line">      map((params: Params): <span class="function"><span class="params">string</span> =&gt;</span> params[<span class="string">'carId'</span>]),</span><br><span class="line">      switchMap((carId: <span class="built_in">string</span>): Observable&lt;Car&gt; =&gt; <span class="keyword">this</span>.cars.getCarByLinkId$(carId)),</span><br><span class="line">      tap(<span class="keyword">this</span>.onCarGotten),</span><br><span class="line">      switchMap((car: Car): Observable&lt;Car&gt; =&gt; <span class="keyword">this</span>.travels.getCarTravel$(car)),</span><br><span class="line">      switchMap((car: Car): Observable&lt;<span class="built_in">number</span>&gt; =&gt; interval(environment.refreshInterval))</span><br><span class="line">    )</span><br><span class="line">    .subscribe(<span class="keyword">this</span>.timeGoesBy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>La narrativa de lo que sucede en esta función es la siguiente:</p><ul><li>1 - Partimos de <code>this.route.params</code>, que es un <em>stream</em> observable de los estados de los parametros de la ruta activa, y que devuelve <code>Observable&lt;Params&gt;</code>.</li><li>2 - Extraemos el parámetro <code>carId</code>, que es un <code>string</code>.</li><li>3 - Realizamos una llamada asincrona para obtener el coche con es identificador. El resultado es un nuevo <em>stream</em> que retorna <code>Observable&lt;Car&gt;</code>.</li><li>4 - Almacenamos el coche e inicializamos indicadores mediante <code>tap</code>. Sin cambiar nada en el curso del arroyo.</li><li>5 - Para continuar el viaje hay que llamar de nuevo al servidor y de forma asíncrona completar o rellenar datos del coche. De nuevo una derivación en la corriente, auqne el tipo siga siendo el mismo: <code>Observable&lt;Car&gt;</code> .</li><li>6 - Al tener los datos ya completos queremos ceder el control al usuario y refrescar los indicadores según su manejo. La repetición de funciones a intervalos encaja en la filosofía <em>Observable</em> y se incorpora en <em>RxJs</em> mediante la función <code>interval(period:number)</code> que retorna una secuencia de números a cada intervalo programado.</li><li>7 - Por último podemos ejecutar una función <em>callback</em> ante cada suceso (emitido por el intervalo) usando la función <code>.subscribe(callback)</code>.</li></ul><p>Reconozco que en un primer vistazo este código pueda resultar complejo. Tómate tu tiempo. Fíjate en los tipos de entrada y salida de cada función. Revísa la aplicación <a href="https://github.com/AcademiaBinaria/autobot/tree/6-http" target="_blank" rel="noopener">Autobot en el repositorio</a>. Especialmente en <code>cars.service.ts</code> y <code>travels.service.ts</code> encontrarás muchos más ejemplos del trabajo con la librería <em>RxJs</em> y la manipulación de <em>streams de eventos observables</em>.</p><p>Ya tenemos un servidor con el que nos comunicamos por <em>http</em>; aunque por ahora de forma anónima. Con el conocimiento actual de los observables y el <em>httpClient</em> estamos a un paso de darle seguridad a las comunicaciones. Sigue esta serie para añadirle <a href="../vigilancia-y-seguridad-en-Angular/">vigilancia y seguridad en Angular</a> mientras aprendes a programar con Angular6.</p><blockquote><p>Aprender, programar, disfrutar, repetir.<br>– <cite>Saludos, Alberto Basalo</cite></p></blockquote></div><footer class="article-footer"><div class="share-container"></div><a data-url="https://academia-binaria.com/comunicaciones-http-en-Angular/" data-id="cjbrwpvin001ziwd3551c6s4a" class="article-share-link"><i class="fa fa-share"></i>Compartir</a><script>!function(n){"undefined"!=typeof __SHARE_BUTTON_BINDED__&&__SHARE_BUTTON_BINDED__||(__SHARE_BUTTON_BINDED__=!0,n("body").on("click",function(){n(".article-share-box.on").removeClass("on")}).on("click",".article-share-link",function(t){t.stopPropagation();var e,a=n(this),o=a.attr("data-url"),i=encodeURIComponent(o),r="article-share-box-"+a.attr("data-id"),s=a.offset();if(n("#"+r).length){if((e=n("#"+r)).hasClass("on"))return void e.removeClass("on")}else{var l=['<div id="'+r+'" class="article-share-box">','<input class="article-share-input" value="'+o+'">','<div class="article-share-links">','<a href="https://twitter.com/intent/tweet?url='+i+'" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>','<a href="https://www.facebook.com/sharer.php?u='+i+'" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>','<a href="http://pinterest.com/pin/create/button/?url='+i+'" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>','<a href="https://plus.google.com/share?url='+i+'" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',"</div>","</div>"].join("");e=n(l),n("body").append(e)}n(".article-share-box.on").hide(),e.css({top:s.top+25,left:s.left}).addClass("on")}).on("click",".article-share-box",function(t){t.stopPropagation()}).on("click",".article-share-box-input",function(){n(this).select()}).on("click",".article-share-box-link",function(t){t.preventDefault(),t.stopPropagation(),window.open(this.href,"article-share-box-window-"+Date.now(),"width=500,height=450")}))}(jQuery)</script><a href="https://academia-binaria.com/comunicaciones-http-en-Angular/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://academia-binaria.com/comunicaciones-http-en-Angular/">Comentarios</a></footer></div><nav id="article-nav"><a href="/vigilancia-y-seguridad-en-Angular/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Reciente</strong><div class="article-nav-title">Vigilancia y seguridad en Angular</div></a><a href="/servicios-inyectables-en-Angular/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Antiguo</strong><div class="article-nav-title">Servicios inyectables en Angular</div></a></nav></article><section id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Recientes</h3><div class="widget"><ul id="recent-post"><li><div class="item-thumbnail"><a href="/velocidad-y-seo-con-el-ssr-de-angular-universal/" class="thumbnail"><span style="background-image:url(/css/images/angular-c_universal.png)" alt="Velocidad y SEO con el SSR de Angular Universal" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/velocidad-y-seo-con-el-ssr-de-angular-universal/" class="title">Velocidad y SEO con el SSR de Angular Universal</a></p><p class="item-date"><time datetime="2018-10-30T11:50:27.000Z" itemprop="datePublished">30-10-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/pwa-entre-la-web-y-las-apps-con-angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-b_pwa.png)" alt="PWA, Entre la web y las apps con Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/pwa-entre-la-web-y-las-apps-con-angular/" class="title">PWA, Entre la web y las apps con Angular</a></p><p class="item-date"><time datetime="2018-10-15T10:50:27.000Z" itemprop="datePublished">15-10-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/el-patron-redux-con-ngrx-en-angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-a_redux.png)" alt="El patrón Redux con NgRx en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/el-patron-redux-con-ngrx-en-angular/" class="title">El patrón Redux con NgRx en Angular</a></p><p class="item-date"><time datetime="2018-10-08T10:50:27.000Z" itemprop="datePublished">08-10-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/deteccion-del-cambio-en-Angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-9_change.png)" alt="Detección del cambio en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/deteccion-del-cambio-en-Angular/" class="title">Detección del cambio en Angular</a></p><p class="item-date"><time datetime="2018-09-28T10:09:27.000Z" itemprop="datePublished">28-09-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/formularios-reactivos-con-Angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-8_reactive.png)" alt="Formularios reactivos con Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/formularios-reactivos-con-Angular/" class="title">Formularios reactivos con Angular</a></p><p class="item-date"><time datetime="2018-09-26T08:59:27.000Z" itemprop="datePublished">26-09-2018</time></p></div></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Categorias</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Avanzado/">Avanzado</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Introduccion/">Introducción</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Opinion/">Opinión</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tutorial/">Tutorial</a><span class="category-list-count">13</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Tutorial/Angular/">Angular</a><span class="category-list-count">13</span></li></ul></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Nube de etiquetas</h3><div class="widget tagcloud"><a href="/tag/Angular/" style="font-size:17.5px">Angular</a> <a href="/tag/Angular2/" style="font-size:20px">Angular2</a> <a href="/tag/Angular5/" style="font-size:17.5px">Angular5</a> <a href="/tag/Angular6/" style="font-size:17.5px">Angular6</a> <a href="/tag/Angular7/" style="font-size:15px">Angular7</a> <a href="/tag/AngularJS/" style="font-size:12.5px">AngularJS</a> <a href="/tag/Avanzado/" style="font-size:15px">Avanzado</a> <a href="/tag/BackEnd/" style="font-size:10px">BackEnd</a> <a href="/tag/Bootstrap/" style="font-size:11.25px">Bootstrap</a> <a href="/tag/CLI/" style="font-size:13.75px">CLI</a> <a href="/tag/ChangeDetection/" style="font-size:10px">ChangeDetection</a> <a href="/tag/Components/" style="font-size:10px">Components</a> <a href="/tag/DI/" style="font-size:11.25px">DI</a> <a href="/tag/Forms/" style="font-size:12.5px">Forms</a> <a href="/tag/FrontEnd/" style="font-size:10px">FrontEnd</a> <a href="/tag/Introduccion/" style="font-size:16.25px">Introducción</a> <a href="/tag/MongoDB/" style="font-size:11.25px">MongoDB</a> <a href="/tag/NgRx/" style="font-size:10px">NgRx</a> <a href="/tag/NodeJS/" style="font-size:13.75px">NodeJS</a> <a href="/tag/Observables/" style="font-size:11.25px">Observables</a> <a href="/tag/PWA/" style="font-size:10px">PWA</a> <a href="/tag/Redux/" style="font-size:10px">Redux</a> <a href="/tag/Routing/" style="font-size:10px">Routing</a> <a href="/tag/RxJS/" style="font-size:10px">RxJS</a> <a href="/tag/SPA/" style="font-size:11.25px">SPA</a> <a href="/tag/SSR/" style="font-size:10px">SSR</a> <a href="/tag/Servicios/" style="font-size:10px">Servicios</a> <a href="/tag/Tutorial/" style="font-size:18.75px">Tutorial</a> <a href="/tag/TypeScript/" style="font-size:10px">TypeScript</a> <a href="/tag/Universal/" style="font-size:10px">Universal</a> <a href="/tag/http/" style="font-size:12.5px">http</a> <a href="/tag/reactiveForms/" style="font-size:10px">reactiveForms</a></div></div><div class="widget-wrap widget-list"><h3 class="widget-title">Links</h3><div class="widget"><ul><li><a href="http://eepurl.com/b3p7fb">Newsletter</a></li><li><a href="http://agorabinaria.com">Ágora Binaria</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Archivos</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">octubre 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">septiembre 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">agosto 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">marzo 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">septiembre 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">junio 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">mayo 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">abril 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">marzo 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">enero 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">noviembre 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">agosto 2015</a><span class="archive-list-count">4</span></li></ul></div></div><div id="toTop" class="fa fa-angle-up"></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2018 Developed by <a target="_blank" href="http://agorabinaria.com">Ágora Binaria</a>.</div></div></footer><script>var disqus_config=function(){this.page.url="https://academia-binaria.com/comunicaciones-http-en-Angular/",this.page.identifier="comunicaciones-http-en-Angular"};!function(){var a=document,e=a.createElement("script");e.src="//academiabinaria.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(a.head||a.body).appendChild(e)}()</script><script src="/js/main.js"></script><script src="//load.sumome.com/" data-sumo-site-id="24f3eb649e85fa1f7db20b7fa344f42f381f65f8f86f7028766c55d313e73eb5" async></script></div></body>