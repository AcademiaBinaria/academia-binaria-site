<!DOCTYPE html><html lang="es"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>El patrón Redux con NgRx en Angular | Academia Binaria</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Le pasa a todas las aplicaciones. Crecen y crecen en funcionalidad y complejidad. En Angular estamos preparados para modularizar, componentizar e inyectar servicios. Pero con grandes aplicaciones, o c"><meta name="keywords" content="Angular,Tutorial,Avanzado,Angular7,Angular2,Redux,NgRx"><meta property="og:type" content="article"><meta property="og:title" content="El patrón Redux con NgRx en Angular"><meta property="og:url" content="https://academia-binaria.com/el-patron-redux-con-ngrx-en-angular/index.html"><meta property="og:site_name" content="Academia Binaria"><meta property="og:description" content="Le pasa a todas las aplicaciones. Crecen y crecen en funcionalidad y complejidad. En Angular estamos preparados para modularizar, componentizar e inyectar servicios. Pero con grandes aplicaciones, o c"><meta property="og:locale" content="es"><meta property="og:image" content="https://academia-binaria.com/css/images/angular-a_redux.png"><meta property="og:updated_time" content="2019-08-02T15:02:25.064Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="El patrón Redux con NgRx en Angular"><meta name="twitter:description" content="Le pasa a todas las aplicaciones. Crecen y crecen en funcionalidad y complejidad. En Angular estamos preparados para modularizar, componentizar e inyectar servicios. Pero con grandes aplicaciones, o c"><meta name="twitter:image" content="https://academia-binaria.com/css/images/angular-a_redux.png"><link rel="alternate" href="http://eepurl.com/b3p7fb" title="Academia Binaria" type="application/atom+xml"><link rel="icon" href="/css/images/favicon.ico"><link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/libs/open-sans/styles.css"><link rel="stylesheet" href="/libs/source-code-pro/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/libs/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript">!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-66674029-1","auto"),ga("send","pageview")</script><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-2476046955705301",enable_page_level_ads:!0})</script></head></html><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><i class="logo"></i> <span class="site-title">Academia Binaria</span></a><nav id="main-nav"><a class="main-nav-link" href="/cursos">Cursos Online</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"><a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/c6ea942080cef8be6ff80ca095e718b8"> <i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form class="search-form"><input type="text" class="ins-search-input search-form-input" placeholder="Buscar"> <button type="submit" class="search-form-submit"></button></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="escribe..."> <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Entradas",PAGES:"Páginas",CATEGORIES:"Categorias",TAGS:"Etiquetas",UNTITLED:"(Untitled)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script></div></div></div><div id="main-nav-mobile" class="header-sub header-inner"><table class="menu outer"><tr><td><a class="main-nav-link" href="/cursos">Cursos Online</a></td><td><div class="search-form"><input type="text" class="ins-search-input search-form-input" placeholder="Buscar"></div></td></tr></table></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"><img id="avatar" src="https://www.gravatar.com/avatar/c6ea942080cef8be6ff80ca095e718b8?s=128"><h2 id="name">Alberto Basalo</h2><h3 id="title">Formador y Consultor</h3><span id="location"><i class="fa fa-map-marker"></i>A Coruña, Spain</span> <a id="follow" target="_blank" href="https://twitter.com/albertobasalo">SEGUIR</a></div><div class="article-info profile-block"><a href="https://angular.builders" style="align-content:center"><img src="/css/images/angular.builders_cuadrado.png" width="100%" height="auto" alt="Angular.Builders"></a></div><div class="profile-block social-links"><table><tr><td><a href="https://github.com/AcademiaBinaria" target="_blank" title="github" class="tooltip"><i class="fa fa-github"></i></a></td><td><a href="https://twitter.com/albertobasalo" target="_blank" title="twitter" class="tooltip"><i class="fa fa-twitter"></i></a></td><td><a href="https://www.facebook.com/Agora.Binaria.SL/" target="_blank" title="facebook" class="tooltip"><i class="fa fa-facebook"></i></a></td><td><a href="http://eepurl.com/b3p7fb" target="_blank" title="rss" class="tooltip"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-el-patron-redux-con-ngrx-en-angular" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">El patrón Redux con NgRx en Angular</h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/el-patron-redux-con-ngrx-en-angular/"><time datetime="2018-10-08T10:50:27.000Z" itemprop="datePublished">08-10-2018</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></div><div class="article-tag"><i class="fa fa-tag"></i> <a class="tag-link" href="/tag/Angular/">Angular</a>, <a class="tag-link" href="/tag/Angular2/">Angular2</a>, <a class="tag-link" href="/tag/Angular7/">Angular7</a>, <a class="tag-link" href="/tag/Avanzado/">Avanzado</a>, <a class="tag-link" href="/tag/NgRx/">NgRx</a>, <a class="tag-link" href="/tag/Redux/">Redux</a>, <a class="tag-link" href="/tag/Tutorial/">Tutorial</a></div></div></header><div class="article-entry" itemprop="articleBody"><p><img src="/images/tutorial-angular-a_redux.png" alt="el-patron-redux-con-ngrx-en-angular"></p><p>Le pasa a todas las aplicaciones. Crecen y crecen en funcionalidad y complejidad. En Angular estamos preparados para modularizar, componentizar e inyectar servicios. Pero con grandes aplicaciones, o con grandes equipos, parece que nada es suficiente. Se necesita una <strong>gestión del estado centralizada</strong> como la del patrón Redux.</p><p><strong>Redux no hace rápido lo simple, sino mantenible lo complejo</strong>. Y si tienes delante un desarrollo complejo, te recomiendo que uses <em>NgRX</em>; la solución estándar para implementar <strong>Redux con Angular</strong>.</p><a id="more"></a><p>Partiendo del código tal cómo quedó en <a href="../deteccion-del-cambio-en-Angular/">Detección del cambio en Angular</a>. Al finalizar tendrás una aplicación que gestiona centralizadamente los cambios, que permite conocer qué ocurrió y predecir lo que ocurrirá.</p><blockquote><p>Código asociado a este artículo en <em>GitHub</em>: <a href="https://github.com/AcademiaBinaria/autobot/tree/a-redux" target="_blank" rel="noopener">AcademiaBinaria/AutoBot/a-redux</a></p></blockquote><h1 id="1-El-patron-Redux"><a href="#1-El-patron-Redux" class="headerlink" title="1 El patrón Redux"></a>1 El patrón Redux</h1><p>Redux es como una base de datos, es en un almacén para el estado de la aplicación. Pero un almacén que gestiona sus cambios de manera predictiva. Combina dos patrones: <em>Action</em> para el envío de comandos para actualizar el estado del almacén; y <em>Observable</em> para la subscripción a cambios en el estado del almacén. <strong>Desacopla los emisores de acciones de los receptores de cambios</strong> en los datos.</p><p>Para lograrlo tendremos que cumplir una serie de principios y utilizar unos elementos predefinidos. Esto introduce capas de abstracción y burocracia que inicialmente complican el desarrollo. Pero a medio plazo harán que mantener la aplicación sea mucho más sencillo y seguro.</p><h2 id="1-1-Principios-de-Redux"><a href="#1-1-Principios-de-Redux" class="headerlink" title="1.1 Principios de Redux"></a>1.1 Principios de Redux</h2><p>Tenemos tres principios básicos que cumplir:</p><ul><li><strong>Single Source Of Truth</strong>: Cada pieza de información se almacena en un único lugar, independientemente de dónde sea creada, modificada o requerida.</li><li><strong>Read Only State</strong>: La información será de sólo lectura y sólo podrá modificarse a través de conductos oficiales.</li><li><strong>Changes By Pure Functions</strong>: Los cambios tienen que poder ser replicados, cancelados y auditados; lo mejor, usar una función pura.</li></ul><h2 id="1-2-Elementos-de-Redux"><a href="#1-2-Elementos-de-Redux" class="headerlink" title="1.2 Elementos de Redux"></a>1.2 Elementos de Redux</h2><p>Estos son los artificios fundamentales que incorporaremos a nuestro desarrollo:</p><ul><li><strong>Store</strong>: El sistema que mantiene el estado. Despacha acciones de mutado sobre el mismo y comunica cambios enviando copias de sólo lectura a los subscriptores.</li><li><strong>State</strong>: Árbol de objetos que contienen la única copia válida de la información. Representa el valor del almacén en un momento determinado.</li><li><strong>Actions</strong>: Objetos identificados por un tipo y cargados con un <em>payload</em>. Transmiten una intención de mutación sobre el estado del <em>store</em>.</li><li><strong>Reducers</strong> : Son funciones puras, que ostentan la exclusividad de poder mutar el estado. Reciben dos argumentos: el estado actual y una acción con su tipo y su carga. Clonan el estado, realizan los cambios oportunos y devuelven el estado mutado.</li></ul><ul><li><strong>Actions</strong>: Objetos identificados por un tipo y cargados con un <em>payload</em>. Transmiten una intención de mutación sobre el estado del almacén. Tomados del patrón comando.</li><li><strong>Reducers</strong> : Son funciones puras, que ostentan la exclusividad de poder mutar el estado. Reciben dos argumentos: el estado actual y una acción con su tipo y su carga. Toman el estado, realizan los cambios oportunos y devuelven el estado mutado.</li><li><strong>Effects</strong> : Los reductores, como funciones puras, no pueden tener efectos secundarios. Es decir: depender o cambiar algo del entorno. Esto debería hacerse antes o después del cambio. En algo que aquí por ahora no usaremos: los efectos.</li></ul><blockquote><p>Los funciones reductoras, al ser puras, mezclan la programación funcional con la orientada a objetos. Un reto pero también una demostración de la coexistencia de paradigmas en un mismo desarrollo.</p></blockquote><h1 id="2-NgRx"><a href="#2-NgRx" class="headerlink" title="2 NgRx"></a>2 NgRx</h1><p>NgRx es el estándar de facto para implementar Redux en Angular. Está basada en <em>RxJS</em> y es una librería modular con todo lo necesario para crear grandes aplicaciones. Esto son los módulos que la componen:</p><ul><li><strong>store</strong>: Es el módulo principal con el administrador del estado centralizado y reactivo.</li><li><strong>store-devtools</strong>: Instrumentación para depurar desde el navegador. Vale su peso en oro.</li><li><strong>router-Store</strong> : Almacena el estado del <em>router</em> de Angular en el <em>store</em>, tratando cada evento como una acción Redux.</li><li><strong>effects</strong>: Los reductores son funciones puras sin efectos colaterales. Este módulo es la solución para comandos asíncronos.</li><li><strong>schematics, entity, ngrx-data</strong>: Son otros módulos opcionales con ayudas y plantillas de NgRX.</li></ul><h2 id="2-1-Instalacion-y-configuracion"><a href="#2-1-Instalacion-y-configuracion" class="headerlink" title="2.1 Instalación y configuración"></a>2.1 Instalación y configuración</h2><p>Para agregar <em>NgRx</em> a un app te propongo la siguiente receta de comandos. Además de esto tendrás que instalar en tu navegador las herramientas de diagnóstico <a href="http://extension.remotedev.io/" target="_blank" rel="noopener">Redux DevTools</a>.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm i @angular-devkit/schematics --save-dev</span><br><span class="line">npm i @ngrx/schematics --save-dev</span><br><span class="line">ng config cli.defaultCollection @ngrx/schematics</span><br><span class="line">npm i @ngrx/store --save</span><br><span class="line">npm i @ngrx/store-devtools --save</span><br><span class="line">ng g st RootState --root -m app.module.ts --spec false</span><br><span class="line">npm install @ngrx/router-store --save</span><br></pre></td></tr></table></figure><p>Con esto habrás instalado y configurado NgRx en tu app. Completa tu módulo principal para que tenga algo así:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    CommonModule,</span><br><span class="line">    RouterModule,</span><br><span class="line">    StoreModule.forRoot(rootReducers, &#123; metaReducers &#125;),</span><br><span class="line">    StoreRouterConnectingModule.forRoot(&#123; stateKey: <span class="string">'router'</span> &#125;),</span><br><span class="line">    !environment.production ? StoreDevtoolsModule.instrument() : []</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123;&#125;</span><br></pre></td></tr></table></figure><blockquote><p>El código generado por <code>@ngrx/schematics</code> no es para todos los gustos. Tómalo como un punto de partida y crea la estructura que mejor te encaje. En <a href="https://github.com/AcademiaBinaria/autobot/tree/a-redux/src/app/core/store/state" target="_blank" rel="noopener">Autobot</a> he empezado por llevarlo todo al <code>CoreModule</code> y guardarlo en una carpeta propia convenientemente nombrada <code>store/state</code>. Veámosla en detalle.</p></blockquote><h2 id="2-2-State-y-reducers-los-cambios-de-estado-mediante-reductores"><a href="#2-2-State-y-reducers-los-cambios-de-estado-mediante-reductores" class="headerlink" title="2.2 State y reducers, los cambios de estado mediante reductores"></a>2.2 State y reducers, los cambios de estado mediante reductores</h2><p>El estado en <em>redux</em> es un objeto tipado a partir de una interfaz, normalmente llamada <code>State</code> a secas, aunque yo prefiero identificarla como <code>RootState</code>. Tendrá propiedades para almacenar objetos más o menos complejos. Cada propiedad tendrá su propio tipo complejo y será gestionada por una función reductora específica. Se necesita un proceso de mapeo que asigne la función reductora a cada propiedad del estado raíz. Eso es lo que hace este código:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> RootState &#123;</span><br><span class="line">  router: <span class="built_in">any</span>;</span><br><span class="line">  global: GlobalState;</span><br><span class="line">  cars: CarsState;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> rootReducers: ActionReducerMap&lt;RootState&gt; = &#123;</span><br><span class="line">  router: routerReducer,</span><br><span class="line">  global: globalreducer,</span><br><span class="line">  cars: carsReducer</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Las funciones reductoras pueden estar en cualquier fichero. Son puras y no deben ser incluidas en ninguna clase. Normalmente tendrás un fichero para cada reductor. El del <em>router</em> ya viene hecho por NgRx, todos los demás son cosa tuya. Por ejemplo este es el reductor sobre la propiedad <code>global: GlobalState</code>.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">globalReducer</span>(<span class="params">state = initialState, action: GlobalActions</span>): <span class="title">GlobalState</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> GlobalActionTypes.SendUserMessage:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, userMessage: action.payload &#125;;</span><br><span class="line">    <span class="keyword">case</span> GlobalActionTypes.IsLoginNeeded:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, loginNeeded: action.payload &#125;;</span><br><span class="line">    <span class="keyword">case</span> GlobalActionTypes.StoreToken:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, token: action.payload &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Como puedes ver esta función recibe dos argumento: el estado y la acción que pretende mutarlo. <strong>La acción es un objeto</strong> con dos propiedades. La primera y obligatoria es el tipo y sirve para escoger la lógica que se aplicará. La otra, opcional, es el <code>payload</code> que actúa como argumento de la acción. El reductor no puede usar nada más que estos argumentos: <strong>state y action</strong>. Y por ser puro no puede mutar ninguno, por tanto tiene que clonar el estado recibido antes de aplicarle cualquier cambio. Una vez efectuado el cambio, usando el <em>payload</em> si es preciso, devolverá el clon mutado.</p><h2 id="2-3-Actions-las-acciones-permitidas"><a href="#2-3-Actions-las-acciones-permitidas" class="headerlink" title="2.3 Actions, las acciones permitidas"></a>2.3 Actions, las acciones permitidas</h2><p>El patrón Redux no obliga a grandes cosas respecto a cómo implementar las acciones. Lo único que de verdad necesitas es crear objetos con una propiedad obligatoria <code>type</code> y otra opcional <code>payoload</code>.</p><p>Pero en NgRX han decidido aprovechar al máximo las capacidades del <em>TypeScript</em> y proponen usar un código fuertemente tipado. Para empezar crean un <code>enum</code> que detalla los posible tipos de una acción y les asigna un texto para que luzcan y faciliten su búsqueda en <em>logs</em>.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">enum</span> GlobalActionTypes &#123;</span><br><span class="line">  SendUserMessage = <span class="string">'[Global] Show Message'</span>,</span><br><span class="line">  IsLoginNeeded = <span class="string">'[Auth] Is Login Needed'</span>,</span><br><span class="line">  StoreToken = <span class="string">'[Auth] Store Token'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Y claro, en un ambiente tipado, la acción será una clase que ha de cumplir una interfaz. En dicha clase queda ya predeterminado su tipo de acción; y por supuesto que permiten fijar el tipo de datos de la <code>payload</code>. Todo ello genera un código como el siguiente.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> SendUserMesage <span class="keyword">implements</span> Action &#123;</span><br><span class="line">  readonly <span class="keyword">type</span> = GlobalActionTypes.SendUserMessage;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">public</span> payload: <span class="built_in">string</span></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Para terminar, y ya que habremos de crear un buen número de clases para las acciones, también nos propone exprimir <em>TypeScript</em> para crear un tipo combinado que ofrezca a los consumidores el plantel completo y delimitado de acciones posibles.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> GlobalActions = SendUserMesage | IsLoginNeeded | StoreToken;</span><br></pre></td></tr></table></figure><p>Es normal que al principio todo este <em>boilerplate</em> te parezca un exceso. Pero entre las plantillas, los <em>snippets</em> y el <em>copy and paste</em> no es tan trabajoso como pudiera parecer. A cambio tienes un código robusto y explícitamente detallado.</p><h2 id="2-4-Dispatch-y-Select-despacho-de-acciones-y-seleccion-de-cambios"><a href="#2-4-Dispatch-y-Select-despacho-de-acciones-y-seleccion-de-cambios" class="headerlink" title="2.4 Dispatch y Select, despacho de acciones y selección de cambios"></a>2.4 Dispatch y Select, despacho de acciones y selección de cambios</h2><p>Desde el resto del código <strong>la comunicación con este estado centralizado se realizará por dos conductos oficiales : Dispatch y Select</strong>. El primero es un método que recibe como único parámetro una instancia de una acción. Dicha instancia lleva implícito el tipo y puede ir rellena de una <em>payload</em>. Así es como se envían los cambios hacia el almacén.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> store: Store&lt;RootState&gt;</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.store.dispatch(<span class="keyword">new</span> SendUserMesage(<span class="string">'Tutorial Angular en Español'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>No esperamos respuesta de este método. Es un mundo de <em>fire and forget</em>. Pero en cualquier otro lugar o lugares de nuestro código podremos recibir notificaciones de cualquier cambio que se haya producido. De forma desacoplada podremos recibir el mensaje con una simple subscripción <em>RxJS</em>.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.store</span><br><span class="line">  .select(<span class="string">'global'</span>, <span class="string">'userMessage'</span>)</span><br><span class="line">  .subscribe(userMessage: <span class="function"><span class="params">string</span> =&gt;</span> <span class="built_in">console</span>.log(userMessage));</span><br></pre></td></tr></table></figure><p>A este método de consulta asíncrona se le envía un argumento con múltiples sobrecargas llamado <em>selector</em>. En este caso está formado por dos claves que apuntan a una propiedad concreta en la que estoy interesado: <code>global.userMessage</code>.</p><p>Con esto tenemos una primera implementación del patrón Redux en Angular usando NgRx. Pero aún hay más.</p><h1 id="3-Efectos-y-modulos-funcionales"><a href="#3-Efectos-y-modulos-funcionales" class="headerlink" title="3 Efectos y módulos funcionales"></a>3 Efectos y módulos funcionales</h1><p>Las funciones reductoras, como ya se ha dicho, deben ser puras. La idea es que puedan ser auditadas, re-ejecutadas y testeadas sin que necesiten servicios externos ni causen efectos colaterales. Y esto es un problema con la cantidad de <strong>ejecuciones asíncronas en las aplicaciones web</strong>. Cualquier tentación de lanzar una llamada <em>AJAX</em> dentro de un reductor debe ser elimindad de inmediato.</p><blockquote><p>Dos razones: por un lado en Angular se necesita invocar al <em>httpClient</em> de alguna manera para realizar la llamada <em>AJAX</em>. Y, ya que la función no pertenece a ninguna clase, no puede haber constructor que reclame la inyección de dicho servicio. Tampoco las funciones puras tienen permitido usar nada que no venga entre sus argumentos. Por otra parte las funciones puras han de ser predecibles, y una llamada a un servidor remoto no es en absoluto predecible. Puede pasarle de todo, así que los reductores no son país para procesos asíncronos.</p></blockquote><p>La solución que proponen <em>NgRX</em> es usar un artificio llamado efecto, porque será encargado de <strong>los efectos secundarios que provocan las las instrucciones asíncronas</strong>. De una forma simplista, diremos que las acciones asíncronas se multiplicarán por tres. El comando que genera la llamada, y los dos potenciales eventos con la respuesta correcta o el error.</p><p>Para manejarlo todo incluyen en la librería el módulo <code>EffectsModule</code> que ha de registrarse junto al <code>StoreModule</code>. Desde ese momento <em>NgRX</em> activa un sistema de seguimiento que trata las acciones como un stream de <em>RxJS</em> y permite subscribirse a la invocación de dichas acciones y tratarlas adecuadamente. Una vez más, aprovechan las características del <em>TypeScript</em> y hacen uso de los decoradores para definir las funciones que responderán a la ejecución de las acciones.</p><h2 id="3-1-Effect-efectos-secundarios"><a href="#3-1-Effect-efectos-secundarios" class="headerlink" title="3.1 @Effect(), efectos secundarios"></a>3.1 @Effect(), efectos secundarios</h2><p>El decorador <code>@Effect()</code> se aplica a propiedades de servicios estándar de Angular. <em>NgRX</em> invoca esas funciones ante cada acción despachada, así que lo primero que debemos hacer es aplicar un filtro para quedarnos con las acciones del tipo que nos interese. El que lanzará la llamada <code>http</code>.</p><blockquote><p>Todo el trabajo se realizará con <em>streams</em> y requiere de un conocimiento previo de la librería <em>RxJS</em> y de la mecánica de su método <code>pipe</code> y sus operadores reactivos.</p></blockquote><p>Cuando llegue una de esas acciones realizaremos la llamada asíncrona sin complejos. Recordemos que un efecto forma parte de un servicio inyectable de Angular. No tienen ninguna restricción funcional por parte de Redux. Obviamente la respuesta debe ser capturada y tratada según haya sido correcta o no.</p><p>Si recibimos una respuesta válida podremos retornar directamente una nueva acción que actualice el estado con los datos recibidos. En cambio si ha habido un error, habrá que reactivar el <em>stream</em> con un nuevo observable que emita la acción que procesará el error.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Effect</span>()</span><br><span class="line"><span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> actions$: Actions, <span class="keyword">private</span> cars: CarsService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> loadCarsEffect$: Observable&lt;CarsActions&gt; = <span class="keyword">this</span>.actions$.pipe(</span><br><span class="line">  ofType&lt;LoadCars&gt;(CarsActionTypes.LoadCars),</span><br><span class="line">  mergeMap(<span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">    <span class="keyword">this</span>.cars.getCars$().pipe(</span><br><span class="line">      map(<span class="function">(<span class="params">cars: Car[]</span>) =&gt;</span> <span class="keyword">new</span> LoadCarsOK(cars)),</span><br><span class="line">      catchError(<span class="function"><span class="params">err</span> =&gt;</span> of(<span class="keyword">new</span> LoadCarsError(<span class="string">'Error loading cars'</span>)))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>Tómate el tiempo necesario para comprender este código. Especialmente los operadores <code>ofType</code> de <em>NgRX</em> y el <code>mergeMap</code> de <em>RxJS</em>. Fíjate bien en los tipos de los datos recibidos y devueltos. El efecto trata con observables de acciones. Recibe una y devuelve otra que puede ser de alguno de los otros dos tipos previstos. En el caso correcto se cambia una acción por otra, en otro caso se crea un nuevo observable mediante el constructor <code>of()</code> antes del retorno.</p><blockquote><p>Para un ejemplo más completo de estos conceptos explora la implementación en el proyecto Autobot. El <a href="https://github.com/AcademiaBinaria/autobot/tree/a-redux/src/app/core" target="_blank" rel="noopener">RootStore</a> hace uso de efectos en la carpeta <code>store/state/cars</code>.</p></blockquote><h2 id="3-2-Feature-modulos-funcionales"><a href="#3-2-Feature-modulos-funcionales" class="headerlink" title="3.2 Feature, módulos funcionales"></a>3.2 Feature, módulos funcionales</h2><p>Ya que Redux está especialmente indicado en grandes aplicaciones pero manteniendo un estado centralizado, es fácil que acabemos con un módulo raíz demasiado pesado que ralentice el inicio de la aplicación. Para adaptar la gestión central a un entorno con módulos cargado con <em>lazyloading</em> necesitamos una última ayuda, de la mano de <code>FeatureModule</code>.</p><p>Esencialmente es una nuevo <em>store</em> supeditado al principal pero que no se define, y por tanto no pesa, hasta que no es necesario. En Autobot el <a href="https://github.com/AcademiaBinaria/autobot/tree/a-redux/src/app/car" target="_blank" rel="noopener">CarModule</a> es un buen ejemplo de <em>store</em> cargado de forma dinámica como una <code>Feature</code>.</p><p>Ya tienes los conocimientos para gestionar de manera centralizada, auditable y predecible el estado de tus programas. El patrón Redux lucirá más cuanto más grande y compleja sea tu aplicación.</p><p>Continúa tu formación avanzada para crear aplicaciones <a href="../pwa-entre-la-web-y-las-apps-con-angular">PWA, entre la web y las apps con Angular</a> y verás como aprendes a programar con Angular 7.</p><blockquote><p>Aprender, programar, disfrutar, repetir.<br>– <cite>Saludos, Alberto Basalo</cite></p></blockquote></div><footer class="article-footer"><div class="share-container"></div><a data-url="https://academia-binaria.com/el-patron-redux-con-ngrx-en-angular/" data-id="cjyh5p4b6000m18s3ou4s1z2u" class="article-share-link"><i class="fa fa-share"></i>Compartir</a><script>!function(n){"undefined"!=typeof __SHARE_BUTTON_BINDED__&&__SHARE_BUTTON_BINDED__||(__SHARE_BUTTON_BINDED__=!0,n("body").on("click",function(){n(".article-share-box.on").removeClass("on")}).on("click",".article-share-link",function(t){t.stopPropagation();var e,a=n(this),o=a.attr("data-url"),i=encodeURIComponent(o),r="article-share-box-"+a.attr("data-id"),s=a.offset();if(n("#"+r).length){if((e=n("#"+r)).hasClass("on"))return void e.removeClass("on")}else{var l=['<div id="'+r+'" class="article-share-box">','<input class="article-share-input" value="'+o+'">','<div class="article-share-links">','<a href="https://twitter.com/intent/tweet?url='+i+'" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>','<a href="https://www.facebook.com/sharer.php?u='+i+'" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>','<a href="http://pinterest.com/pin/create/button/?url='+i+'" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>','<a href="https://plus.google.com/share?url='+i+'" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',"</div>","</div>"].join("");e=n(l),n("body").append(e)}n(".article-share-box.on").hide(),e.css({top:s.top+25,left:s.left}).addClass("on")}).on("click",".article-share-box",function(t){t.stopPropagation()}).on("click",".article-share-box-input",function(){n(this).select()}).on("click",".article-share-box-link",function(t){t.preventDefault(),t.stopPropagation(),window.open(this.href,"article-share-box-window-"+Date.now(),"width=500,height=450")}))}(jQuery)</script></footer></div><nav id="article-nav"><a href="/typescript-programa-en-el-front-igual-que-en-el-back/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Anterior</strong><div class="article-nav-title">TypeScript, programa en el front igual que en el back</div></a><a href="/pwa-entre-la-web-y-las-apps-con-angular/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Siguiente</strong><div class="article-nav-title">PWA, Entre la web y las apps con Angular</div></a></nav><p><a href="https://www.trainingit.es/curso-angular-basico/?promo=angular.builders">Código promo para: Curso online de introducción a Angular</a></p><hr><p><a href="https://www.trainingit.es/curso-angular-avanzado/?promo=angular.builders">Código promo para: Curso online avanzado con Angular</a></p><a href="https://angular.builders"><img src="/css/images/angular.builders.png" alt="Angular.Builders"></a><hr></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Recientes</h3><div class="widget"><ul id="recent-post"><li><div class="item-thumbnail"><a href="/componentes-dinamicos-directivas-y-pipes-con-Angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-13_template.png)" alt="Componentes dinámicos, directivas y pipes con Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/componentes-dinamicos-directivas-y-pipes-con-Angular/" class="title">Componentes dinámicos, directivas y pipes con Angular</a></p><p class="item-date"><time datetime="2019-09-13T12:27:09.000Z" itemprop="datePublished">13-09-2019</time></p></div></li><li><div class="item-thumbnail"><a href="/deteccion-del-cambio-en-Angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-12_change.png)" alt="Detección del cambio en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/deteccion-del-cambio-en-Angular/" class="title">Detección del cambio en Angular</a></p><p class="item-date"><time datetime="2019-09-11T16:09:27.000Z" itemprop="datePublished">11-09-2019</time></p></div></li><li><div class="item-thumbnail"><a href="/tests-unitarios-con-jest-y-e2e-con-cypress-en-Angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-11_test.png)" alt="Tests unitarios con Jest y e2e con Cypress en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/tests-unitarios-con-jest-y-e2e-con-cypress-en-Angular/" class="title">Tests unitarios con Jest y e2e con Cypress en Angular</a></p><p class="item-date"><time datetime="2019-09-05T12:25:12.000Z" itemprop="datePublished">05-09-2019</time></p></div></li><li><div class="item-thumbnail"><a href="/nx-mono-repositorios-en-Angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-10_monorepo.png)" alt="Nx, mono repositorios en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/nx-mono-repositorios-en-Angular/" class="title">Nx, mono repositorios en Angular</a></p><p class="item-date"><time datetime="2019-09-03T16:59:27.000Z" itemprop="datePublished">03-09-2019</time></p></div></li><li><div class="item-thumbnail"><a href="/flujo-reactivo-unidireccional-con-Angular-y-RxJs/" class="thumbnail"><span style="background-image:url(/css/images/angular-14_unidirectional.png)" alt="Flujo reactivo unidireccional con Angular y RxJs" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/flujo-reactivo-unidireccional-con-Angular-y-RxJs/" class="title">Flujo reactivo unidireccional con Angular y RxJs</a></p><p class="item-date"><time datetime="2019-08-05T09:46:34.000Z" itemprop="datePublished">05-08-2019</time></p></div></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Categorias</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Tutorial/">Tutorial</a><span class="category-list-count">18</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Tutorial/Angular/">Angular</a><span class="category-list-count">18</span></li></ul></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Nube de etiquetas</h3><div class="widget tagcloud"><a href="/tag/Angular/" style="font-size:20px">Angular</a> <a href="/tag/Angular2/" style="font-size:18.75px">Angular2</a> <a href="/tag/Angular6/" style="font-size:11.25px">Angular6</a> <a href="/tag/Angular7/" style="font-size:15px">Angular7</a> <a href="/tag/Angular8/" style="font-size:18.75px">Angular8</a> <a href="/tag/AngularJS/" style="font-size:10px">AngularJS</a> <a href="/tag/Avanzado/" style="font-size:16.25px">Avanzado</a> <a href="/tag/BackEnd/" style="font-size:10px">BackEnd</a> <a href="/tag/CLI/" style="font-size:11.25px">CLI</a> <a href="/tag/ChangeDetection/" style="font-size:10px">ChangeDetection</a> <a href="/tag/Components/" style="font-size:10px">Components</a> <a href="/tag/Cypress/" style="font-size:10px">Cypress</a> <a href="/tag/DI/" style="font-size:10px">DI</a> <a href="/tag/Forms/" style="font-size:10px">Forms</a> <a href="/tag/FrontEnd/" style="font-size:10px">FrontEnd</a> <a href="/tag/Introduccion/" style="font-size:17.5px">Introducción</a> <a href="/tag/Jest/" style="font-size:10px">Jest</a> <a href="/tag/MongoDB/" style="font-size:10px">MongoDB</a> <a href="/tag/NgRx/" style="font-size:10px">NgRx</a> <a href="/tag/NodeJS/" style="font-size:13.75px">NodeJS</a> <a href="/tag/Nx/" style="font-size:11.25px">Nx</a> <a href="/tag/Observables/" style="font-size:11.25px">Observables</a> <a href="/tag/Opinion/" style="font-size:12.5px">Opinión</a> <a href="/tag/PWA/" style="font-size:10px">PWA</a> <a href="/tag/Redux/" style="font-size:10px">Redux</a> <a href="/tag/Routing/" style="font-size:10px">Routing</a> <a href="/tag/RxJS/" style="font-size:10px">RxJS</a> <a href="/tag/RxJs/" style="font-size:10px">RxJs</a> <a href="/tag/SPA/" style="font-size:10px">SPA</a> <a href="/tag/SSR/" style="font-size:10px">SSR</a> <a href="/tag/Servicios/" style="font-size:10px">Servicios</a> <a href="/tag/Template/" style="font-size:10px">Template</a> <a href="/tag/Test/" style="font-size:10px">Test</a> <a href="/tag/Tutorial/" style="font-size:20px">Tutorial</a> <a href="/tag/TypeScript/" style="font-size:10px">TypeScript</a> <a href="/tag/Universal/" style="font-size:10px">Universal</a> <a href="/tag/http/" style="font-size:11.25px">http</a> <a href="/tag/material/" style="font-size:10px">material</a> <a href="/tag/reactiveForms/" style="font-size:10px">reactiveForms</a></div></div><div class="widget-wrap widget-list"><h3 class="widget-title">Links</h3><div class="widget"><ul><li><a href="https://www.trainingit.es/curso-angular-basico/?promo=angular.builders">Intro</a></li><li><a href="https://www.trainingit.es/curso-angular-avanzado/?promo=angular.builders">Avanzado</a></li><li><a href="https://www.trainingit.es/curso-typescript/?promo=meetup10&af=abasalo">TypeScript</a></li><li><a href="http://referral.pluralsight.com/mQe488E">PluralSight</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Archivos</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">septiembre 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">agosto 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">marzo 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">febrero 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">enero 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">octubre 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">marzo 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">mayo 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">abril 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">marzo 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">enero 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">agosto 2015</a><span class="archive-list-count">1</span></li></ul></div></div><div id="toTop" class="fa fa-angle-up"></div><div><a href="https://angular.builders" style="align-content:center"><img src="/css/images/angular.builders.png" width="100%" height="auto" alt="Angular.Builders"></a></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2019 Developed by <a target="_blank" href="http://agorabinaria.com">Ágora Binaria</a>.</div></div></footer><script src="/js/main.js"></script><script src="//load.sumome.com/" data-sumo-site-id="24f3eb649e85fa1f7db20b7fa344f42f381f65f8f86f7028766c55d313e73eb5" async></script></div></body>