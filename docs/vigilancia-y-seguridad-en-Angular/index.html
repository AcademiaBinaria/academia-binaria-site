<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"><title>Vigilancia y seguridad en Angular | Academia Binaria</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="La seguridad de los datos es una responsabilidad compartida entre el servidor y el cliente. En Angular 6 usaremos los interceptores para detectar intrusos y enviar credenciales. Veremos como los guard"><meta name="keywords" content="Angular2,Tutorial,http,Angular,Angular5,Introducción,Angular6,Observables"><meta property="og:type" content="article"><meta property="og:title" content="Vigilancia y seguridad en Angular"><meta property="og:url" content="https://academia-binaria.com/vigilancia-y-seguridad-en-Angular/index.html"><meta property="og:site_name" content="Academia Binaria"><meta property="og:description" content="La seguridad de los datos es una responsabilidad compartida entre el servidor y el cliente. En Angular 6 usaremos los interceptores para detectar intrusos y enviar credenciales. Veremos como los guard"><meta property="og:locale" content="es"><meta property="og:image" content="https://academia-binaria.com/css/images/angular-7_watch.png"><meta property="og:updated_time" content="2018-09-20T09:22:03.604Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Vigilancia y seguridad en Angular"><meta name="twitter:description" content="La seguridad de los datos es una responsabilidad compartida entre el servidor y el cliente. En Angular 6 usaremos los interceptores para detectar intrusos y enviar credenciales. Veremos como los guard"><meta name="twitter:image" content="https://academia-binaria.com/css/images/angular-7_watch.png"><link rel="alternate" href="http://eepurl.com/b3p7fb" title="Academia Binaria" type="application/atom+xml"><link rel="icon" href="/css/images/favicon.ico"><link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/libs/open-sans/styles.css"><link rel="stylesheet" href="/libs/source-code-pro/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/libs/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript">!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-66674029-1","auto"),ga("send","pageview")</script></head></html><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><i class="logo"></i> <span class="site-title">Academia Binaria</span></a><nav id="main-nav"><a class="main-nav-link" href="/tag/Angular">Tutorial para aprender Angular</a></nav><nav id="sub-nav"><div class="profile" id="profile-nav"><a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/c6ea942080cef8be6ff80ca095e718b8"> <i class="fa fa-caret-down"></i></a></div></nav><div id="search-form-wrap"><form class="search-form"><input type="text" class="ins-search-input search-form-input" placeholder="Buscar"> <button type="submit" class="search-form-submit"></button></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="escribe..."> <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Entradas",PAGES:"Páginas",CATEGORIES:"Categorias",TAGS:"Etiquetas",UNTITLED:"(Untitled)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script></div></div></div><div id="main-nav-mobile" class="header-sub header-inner"><table class="menu outer"><tr><td><a class="main-nav-link" href="/tag/Angular">Tutorial para aprender Angular</a></td><td><div class="search-form"><input type="text" class="ins-search-input search-form-input" placeholder="Buscar"></div></td></tr></table></div></header><div class="outer"><aside id="profile"><div class="inner profile-inner"><div class="base-info profile-block"><img id="avatar" src="https://www.gravatar.com/avatar/c6ea942080cef8be6ff80ca095e718b8?s=128"><h2 id="name">Alberto Basalo</h2><h3 id="title">Formador y Consultor</h3><span id="location"><i class="fa fa-map-marker"></i>A Coruña, Spain</span> <a id="follow" target="_blank" href="https://twitter.com/albertobasalo">SEGUIR</a></div><div class="article-info profile-block"><div class="article-info-block"><a target="_blank" href="http://atlanticbootcamp.com">Atlantic</a></div><div class="article-info-block"><a target="_blank" href="http://agorabinaria.com">Ágora</a></div></div><div class="profile-block social-links"><table><tr><td><a href="https://github.com/AcademiaBinaria" target="_blank" title="github" class="tooltip"><i class="fa fa-github"></i></a></td><td><a href="https://twitter.com/albertobasalo" target="_blank" title="twitter" class="tooltip"><i class="fa fa-twitter"></i></a></td><td><a href="https://www.facebook.com/Agora.Binaria.SL/" target="_blank" title="facebook" class="tooltip"><i class="fa fa-facebook"></i></a></td><td><a href="http://eepurl.com/b3p7fb" target="_blank" title="rss" class="tooltip"><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id="main"><article id="post-vigilancia-y-seguridad-en-Angular" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">Vigilancia y seguridad en Angular</h1><div class="article-meta"><div class="article-date"><i class="fa fa-calendar"></i> <a href="/vigilancia-y-seguridad-en-Angular/"><time datetime="2018-09-20T09:49:27.000Z" itemprop="datePublished">20-09-2018</time></a></div><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></div><div class="article-tag"><i class="fa fa-tag"></i> <a class="tag-link" href="/tag/Angular/">Angular</a>, <a class="tag-link" href="/tag/Angular2/">Angular2</a>, <a class="tag-link" href="/tag/Angular5/">Angular5</a>, <a class="tag-link" href="/tag/Angular6/">Angular6</a>, <a class="tag-link" href="/tag/Introduccion/">Introducción</a>, <a class="tag-link" href="/tag/Observables/">Observables</a>, <a class="tag-link" href="/tag/Tutorial/">Tutorial</a>, <a class="tag-link" href="/tag/http/">http</a></div></div></header><div class="article-entry" itemprop="articleBody"><p><img src="/images/tutorial-angular-7_watch.png" alt="vigilancia-y-seguridad-en-Angular"></p><p>La seguridad de los datos es una responsabilidad compartida entre el servidor y el cliente. En <strong>Angular 6</strong> usaremos los <em>interceptores</em> para detectar intrusos y enviar credenciales. Veremos como los <em>guards</em> nos permiten controlar la navegación interna y los <em>resolvers</em> nos aseguran los datos por adelantado.</p><p>La <strong>identificación de usuarios y el control</strong> de acceso y navegación es parte del trabajo de un desarrollador front-end. Veremos nuevos usos de los <em>observables</em> y los servicios de la librerías <code>@angular/common/http</code> y <code>@angular\router</code> con los que tratar <strong>comunicaciones seguras y fluidas en Angular</strong>.</p><a id="more"></a><p>Partiendo de la aplicación tal cómo quedó en <a href="../comunicaciones-http-en-Angular/">Comunicaciones http en Angular</a>. Al finalizar tendrás una aplicación que identifica usuarios y se responsabiliza de almacenar y comunicar el <em>token</em> de seguridad de un servicio REST y mejora la usabilidad controlando la entrada y la salida en las páginas.</p><blockquote><p>Código asociado a este artículo en <em>GitHub</em>: <a href="https://github.com/AcademiaBinaria/autobot/tree/7-watch" target="_blank" rel="noopener">AcademiaBinaria/AutoBot/7-watch</a></p><blockquote><p>Tienes una versión desplegada operativa para probar <a href="https://academiabinaria.github.io/autobot/" target="_blank" rel="noopener">AutoBot</a></p></blockquote></blockquote><h1 id="1-Resolver"><a href="#1-Resolver" class="headerlink" title="1 Resolver"></a>1 Resolver</h1><p>Cuando las una ruta se activa, el router de angular carga un componente en la vista. Bien, pero normalmente necesitará unos datos para ser mostrados. Y casi siempre serán datos de obrtención asíncrona. Lo cual nos lleva a tener que esperar antes de mostrar y mostrar vacíos, o cargando… En cualquier caso tendremos algún que otro <em>if</em> comprobando si los datos están listos o no.</p><p>Una posible solución vienen de la mano de los <em>resolvers</em>. Son servicios que implementan la interfaz <code>Resolve&lt;any&gt;</code> y que se ejecutan (resuelven) antes de cargar el componente de la ruta activa. Cuando termina avisa al router y este pone a disposición del componente los datos ya cargados, liberándolo de la lógica de carga, espera y comprobación. A cambio, la transición hacia la ruta no es tan fluida y agradece una buena animación.</p><p>Veamos por ejemplo la ruta raíz de Autobot que necesita la lista de coches para empezar. Esta solución invoucra tres ficheros.</p><h2 id="1-1-Interfaz-Resolve"><a href="#1-1-Interfaz-Resolve" class="headerlink" title="1.1 Interfaz Resolve"></a>1.1 Interfaz Resolve</h2><p>En el fichero <code>cars-resolver.service.ts</code> partimos de un servicio inyectable local y le hacemos implementar la interfaz <code>Resolve&lt;Cars[]&gt;</code>:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CarsResolverService <span class="keyword">implements</span> Resolve&lt;Car[]&gt; &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> cars: CarsService</span>) &#123;&#125;</span><br><span class="line">  <span class="keyword">public</span> resolve = (route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable&lt;Car[]&gt; =&gt; <span class="keyword">this</span>.cars.getCars$();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>El método devuelve un observable al que se subscribe el router.</p><h2 id="1-2-Routes"><a href="#1-2-Routes" class="headerlink" title="1.2 Routes"></a>1.2 Routes</h2><p>En el fichero de configuración de rutas <code>home-routing.module.ts</code> nos encontramos con el uso del <code>CarsResolverService</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [&#123;</span><br><span class="line">  path: <span class="string">''</span>,</span><br><span class="line">  component: HomeComponent,</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    cars: CarsResolverService</span><br><span class="line">  &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><p>Lo que hace el Angular Router es subscribirse al método <code>resolve</code> y almacenar su respuesta en una variable, en este caso llamada <code>cars</code>. Dicha variable será consumida de forma síncrona por el componente.</p><h2 id="1-3-Snapshot-data"><a href="#1-3-Snapshot-data" class="headerlink" title="1.3 Snapshot data"></a>1.3 Snapshot data</h2><p>El <code>HomeComponent</code> no interactúa directamente con el resolver y por tanto no reclama el servicio en sus dependencias. Símplemente trabaja con el router.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> cars: Car[];</span><br><span class="line"><span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> route: ActivatedRoute</span>) &#123;&#125;</span><br><span class="line"><span class="keyword">public</span> ngOnInit() &#123;</span><br><span class="line">  <span class="keyword">this</span>.cars = <span class="keyword">this</span>.route.snapshot.data.cars;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>No hay necesidad de subscripción ni de control extra en la vista sobre la propiedad <code>cars</code>. Este patrón es recomendable cuando no queremos mostrar una vista a medio cargar, o cuando la lógica de carga asíncrona complica demasiado el componente.</p><h1 id="2-Interceptor"><a href="#2-Interceptor" class="headerlink" title="2 Interceptor"></a>2 Interceptor</h1><p>Hasta ahora todas las comunicacione con nuestro servidor ha sido anónimas. Los datos eran públicos y no se exigía nada para poder leer o guardar información. Pero no siempre es así y los procesos de envío y recepción de datos del servidor suelen ser nominales y por tanto requieren de una identificación del usuario.</p><p>La seguridad de las comunicaciones con un servicio REST se resuelve habitualmente mediante una <strong>credencial generada por el servidor llamada <em>token</em></strong>. Un usuario registrado en el sistema puede hacer <em>log in</em> enviando una vez su identificador y contraseña. Si todo va bien, a cambio el servidor le enviará un <em>token</em> que deberá usar en las siguientes llamadas. Con esto el servidor será capaz de autentificar las llamadas y responder adecuadamente.</p><p>La detección de fallos y el envío de credenciales es algo que haremos a casi todas las llamadas http. Parece razonable disponer de un mecanísmo único que se aplique a todas las llamdas sin necesidad de ir una por una. En Angular, eso se consigue con los interceptores.</p><h2 id="2-1-Interfaz-HttpInterceptor"><a href="#2-1-Interfaz-HttpInterceptor" class="headerlink" title="2.1 Interfaz HttpInterceptor"></a>2.1 Interfaz HttpInterceptor</h2><p>El módulo http de Angular nos ofrexe una interfaz para implementar en servicios estándar y convertirlos en interceptores. En la interfaz <code>HttpInterceptor</code> que obliga a crear el método intercept que nos deja una firma un pelín compleja, <code>intercept(req: HttpRequest&lt;any&gt;, next: HttpHandler):Observable&lt;HttpEvent&lt;any&gt;&gt;</code> . Vayamos por partes:</p><ul><li><code>req: HttpRequest&lt;any&gt;</code> es un puntero a la peticíon en curso y su tipo deja bien claro que es eso, una http request.</li><li><code>next: HttpHandler</code> cada petición es manipulada por múltiples manejadores y cada interceptor es encadenado al siguiente manejador mediante este parámetro.</li><li><code>: Observable&lt;HttpEvent&lt;any&gt;&gt;</code>el tipo devuelto es llamativo porque además de ser un observable, resulta que usa un doble genérico. La razón es que este observable, no se queda simplemente con el evento de respuesta si no que observa cualquier evento http que le suceda a la petión. Entre ellos estará la recepción de la respuesta. Pero es uno más.</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> intercept(req: HttpRequest&lt;<span class="built_in">any</span>&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> next.handle(req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>La respuesta del método se puede simplificar con <code>next.handle(req)</code>. Esto sería tener un interceptor que no hace abosolutamente nada. Habitualmente usaremos los interceptores para mutar la llamada, procesar la respuesta o ambas como en este caso.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> intercept(req: HttpRequest&lt;<span class="built_in">any</span>&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> authReq = <span class="keyword">this</span>.getReqWithAuthorization(req);</span><br><span class="line">  <span class="keyword">return</span> next.handle(authReq).pipe(tap(<span class="literal">null</span>, <span class="keyword">this</span>.handleError));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>La llamada en curso no se puede modificar alegremente. Es inmutable, y por tanto, exige ser clonada si queremos hacer algún cambio. Afortunadamente Angular nos ofrece de métodos de clonación y mutado para las operaciones más habituales, como agregar una cabecera de autorización adjuntando un token a cada llamada. Claro que para que esto funcione <code>this.token</code> ha de tener un valor del que por ahora no tenemos ni idea.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> getReqWithAuthorization = <span class="function">(<span class="params">req: HttpRequest&lt;<span class="built_in">any</span>&gt;</span>) =&gt;</span></span><br><span class="line">  req.clone(&#123;</span><br><span class="line">    setHeaders: &#123; Authorization: <span class="string">`Bearer <span class="subst">$&#123;this.token&#125;</span>`</span> &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><blockquote><p>En Angular promueven el uso de funciones y datos <em>inmutables</em> de ahí que nos obliguen a clonar las cabeceras para modificarlas.</p></blockquote><p>La otra gran labor encomendada a los interceptores es procesar las respuestas cuando lleguen desde el API. Para ello no hay más que entubar el operador RxJS adecuado en el stream de la petición. Por ejemplo un capturador genérico de errores con una especial atención al 401.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> handleError = <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> userMessage = <span class="string">'Fatal error'</span>;</span><br><span class="line">  <span class="keyword">if</span> (err <span class="keyword">instanceof</span> HttpErrorResponse) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.status === <span class="number">401</span>) &#123;</span><br><span class="line">      userMessage = <span class="string">'Authorization needed'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      userMessage = <span class="string">'Comunications error'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(userMessage);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>A parte de toda la <em>liturgia</em> a la que nos obliga el <code>HttpInterceptor</code>, al final la lógica es sencilla. Se trata de rellenar la cabecera con el token actual. Si es o no válido es algo que decidirá el servidor. Aquí simplemente envías lo que tienes.</p></blockquote><h2 id="2-2-Enviar-credenciales-para-obtener-un-token"><a href="#2-2-Enviar-credenciales-para-obtener-un-token" class="headerlink" title="2.2 Enviar credenciales para obtener un token"></a>2.2 Enviar credenciales para obtener un token</h2><p>Una correcta separación de responsabilidades no debe exigir nada más al interceptor. Debemos provverle de un mecanismo mediante el cual pueda notificar fallos de seguridad. Y de otro con el que pueda estar al tanto de cambios en el testigo de identificación del usuario.</p><p>Esa labor la realizaremos en un servicio de intermediación. Hay muchas soluciones para este problema: un bus de enventos es una de ellas. Y un refinamiento del mismo es el patrón redux. Sin complicarnos demasiado, podemos empezar con una implementación <em>naive</em> como la del servicio <code>core/global-store.service.ts</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> GlobalStoreService &#123;</span><br><span class="line">  <span class="keyword">private</span> state: GlobalState = &#123; token: <span class="string">''</span>, userMessage: <span class="string">''</span>, loginNeeded: <span class="literal">false</span> &#125;;</span><br><span class="line">  <span class="keyword">private</span> token$ = <span class="keyword">new</span> BehaviorSubject&lt;<span class="built_in">string</span>&gt;(<span class="keyword">this</span>.state.token);</span><br><span class="line">  <span class="keyword">private</span> userMessage$ = <span class="keyword">new</span> BehaviorSubject&lt;<span class="built_in">string</span>&gt;(<span class="keyword">this</span>.state.userMessage);</span><br><span class="line">  <span class="keyword">private</span> loginNeeded$ = <span class="keyword">new</span> BehaviorSubject&lt;<span class="built_in">boolean</span>&gt;(<span class="keyword">this</span>.state.loginNeeded);</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">  <span class="keyword">public</span> selectToken$ = (): Observable&lt;<span class="built_in">string</span>&gt; =&gt; <span class="keyword">this</span>.token$.asObservable();</span><br><span class="line">  <span class="keyword">public</span> selectUserMessage$ = (): Observable&lt;<span class="built_in">string</span>&gt; =&gt; <span class="keyword">this</span>.userMessage$.asObservable();</span><br><span class="line">  <span class="keyword">public</span> selectLoginNeeded$ = (): Observable&lt;<span class="built_in">boolean</span>&gt; =&gt; <span class="keyword">this</span>.loginNeeded$.asObservable();</span><br><span class="line">  <span class="keyword">public</span> dispatchToken = <span class="function">(<span class="params">token: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.state.token = token;</span><br><span class="line">    <span class="keyword">this</span>.token$.next(<span class="keyword">this</span>.state.token);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">public</span> dispatchUserMessage = <span class="function">(<span class="params">userMessage: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.state.userMessage = userMessage;</span><br><span class="line">    <span class="keyword">this</span>.userMessage$.next(<span class="keyword">this</span>.state.userMessage);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">public</span> dispatchLoginNeeded = <span class="function">(<span class="params">loginNeeded: <span class="built_in">boolean</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.state.loginNeeded = loginNeeded;</span><br><span class="line">    <span class="keyword">this</span>.loginNeeded$.next(<span class="keyword">this</span>.state.loginNeeded);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Sin entrar en mucho detalle, por ahora, esta clase es un intermediario que permite comunicar objetos despachando operaciones y recibir notificaciones subscribiendonos a temas de interés seleccionados.</p><p>En el caso de la seguridad, el interceptor notifica los fallos y recibe los cambios en el token. Este es un extracto de la funcionalidad usada en el <code>AuthInterceptorService</code>.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> token: <span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> globalStore: GlobalStoreService</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.globalStore.selectToken$().subscribe(<span class="function">(<span class="params">token: <span class="built_in">string</span></span>) =&gt;</span> (<span class="keyword">this</span>.token = token));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> handleError = <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err <span class="keyword">instanceof</span> HttpErrorResponse &amp;&amp; err.status === <span class="number">401</span>) &#123;</span><br><span class="line">     <span class="keyword">this</span>.globalStore.dispatchLoginNeeded(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>En algún lugar de la ráiz de la plcación, como el <code>core/vavigator.componente.ts</code> es necesario escuchar ciertos eventos y redirigir al usuario convenientemente.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> NavigatorComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> globalStore: GlobalStoreService, <span class="keyword">private</span> router: Router</span>) &#123;&#125;</span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.globalStore.selectLoginNeeded$().subscribe(<span class="function"><span class="params">loginNeeded</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (loginNeeded) &#123;</span><br><span class="line">        <span class="keyword">this</span>.router.navigateByUrl(<span class="string">'/auth'</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.router.navigateByUrl(<span class="string">'/'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Por supuesto que necesitaremos un formulario que recoja las credenciales del usuario y la envíe al servidor para validar y su cusao recibir un token. Pero todo eso lo tienes en el repositorio de ejemplo. Aquí simplemente pongo la pieza que cierra el círulo de la seguridad, la recepcióndel token en <code>auth/access.component.ts</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AccessComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient, <span class="keyword">private</span> globalStore: GlobalStoreService</span>) &#123;&#125;</span><br><span class="line">  <span class="keyword">public</span> onLogin() &#123;</span><br><span class="line">    <span class="keyword">this</span>.http.post(<span class="keyword">this</span>.url, <span class="keyword">this</span>.credentials)</span><br><span class="line">      .subscribe(<span class="function"><span class="params">authResponse</span> =&gt;</span> <span class="keyword">this</span>.globalStore.dispatchToken(authResponse.token));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Si se aceptan las credenciales, <strong>el servidor nos devolverá un objeto con el <em>token</em> de la sesión</strong> para el usuario. Es habitual que envíe más información como roles, y preferencias del usuario… pero eso ya depende del API. Lo que depende de ti es guardar ese <em>token</em>.</p><p>El <strong>almacenamiento recomendado en los navegadores es el <code>localStorage</code> o el <code>sessionStorage</code></strong> pero en este tutorial introductorio tendrás que conformarte con almacenarlo en la memoria.</p><h1 id="3-Guardias"><a href="#3-Guardias" class="headerlink" title="3 Guardias"></a>3 Guardias</h1><p><code>car/travel.guard.ts</code><br><em>Work in progress…</em></p><hr><p>Ya tenemos al usuario identificado y los datos se envían o reciben acompañados de una cabecera que el servidor interpreta como una firma; lo básico para un sistema mínimamente seguro. Sigue esta serie para crear tus <a href="../formularios-reactivos-con-Angular/">formularios reactivos con Angular</a> mientras aprendes a programar con Angular6.</p><blockquote><p>Aprender, programar, disfrutar, repetir.<br>– <cite>Saludos, Alberto Basalo</cite></p></blockquote></div><footer class="article-footer"><div class="share-container"></div><a data-url="https://academia-binaria.com/vigilancia-y-seguridad-en-Angular/" data-id="cjbrwpvi7001siwd3xpxrryku" class="article-share-link"><i class="fa fa-share"></i>Compartir</a><script>!function(n){"undefined"!=typeof __SHARE_BUTTON_BINDED__&&__SHARE_BUTTON_BINDED__||(__SHARE_BUTTON_BINDED__=!0,n("body").on("click",function(){n(".article-share-box.on").removeClass("on")}).on("click",".article-share-link",function(t){t.stopPropagation();var e,a=n(this),o=a.attr("data-url"),i=encodeURIComponent(o),r="article-share-box-"+a.attr("data-id"),s=a.offset();if(n("#"+r).length){if((e=n("#"+r)).hasClass("on"))return void e.removeClass("on")}else{var l=['<div id="'+r+'" class="article-share-box">','<input class="article-share-input" value="'+o+'">','<div class="article-share-links">','<a href="https://twitter.com/intent/tweet?url='+i+'" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>','<a href="https://www.facebook.com/sharer.php?u='+i+'" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>','<a href="http://pinterest.com/pin/create/button/?url='+i+'" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>','<a href="https://plus.google.com/share?url='+i+'" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',"</div>","</div>"].join("");e=n(l),n("body").append(e)}n(".article-share-box.on").hide(),e.css({top:s.top+25,left:s.left}).addClass("on")}).on("click",".article-share-box",function(t){t.stopPropagation()}).on("click",".article-share-box-input",function(){n(this).select()}).on("click",".article-share-box-link",function(t){t.preventDefault(),t.stopPropagation(),window.open(this.href,"article-share-box-window-"+Date.now(),"width=500,height=450")}))}(jQuery)</script><a href="https://academia-binaria.com/vigilancia-y-seguridad-en-Angular/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://academia-binaria.com/vigilancia-y-seguridad-en-Angular/">Comentarios</a></footer></div><nav id="article-nav"><a href="/comunicaciones-http-en-Angular/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Antiguo</strong><div class="article-nav-title">Comunicaciones http en Angular</div></a></nav></article><section id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Recientes</h3><div class="widget"><ul id="recent-post"><li><div class="item-thumbnail"><a href="/vigilancia-y-seguridad-en-Angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-7_watch.png)" alt="Vigilancia y seguridad en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/vigilancia-y-seguridad-en-Angular/" class="title">Vigilancia y seguridad en Angular</a></p><p class="item-date"><time datetime="2018-09-20T09:49:27.000Z" itemprop="datePublished">20-09-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/comunicaciones-http-en-Angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-6_http.png)" alt="Comunicaciones http en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/comunicaciones-http-en-Angular/" class="title">Comunicaciones http en Angular</a></p><p class="item-date"><time datetime="2018-09-14T09:06:00.000Z" itemprop="datePublished">14-09-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/servicios-inyectables-en-Angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-5_inject.png)" alt="Servicios inyectables en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/servicios-inyectables-en-Angular/" class="title">Servicios inyectables en Angular</a></p><p class="item-date"><time datetime="2018-09-11T08:44:58.000Z" itemprop="datePublished">11-09-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/flujo-de-datos-entre-componentes-angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-4_flow.png)" alt="Flujo de datos entre componentes Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/flujo-de-datos-entre-componentes-angular/" class="title">Flujo de datos entre componentes Angular</a></p><p class="item-date"><time datetime="2018-09-06T15:10:44.000Z" itemprop="datePublished">06-09-2018</time></p></div></li><li><div class="item-thumbnail"><a href="/formularios-tablas-y-modelos-de-datos-en-angular/" class="thumbnail"><span style="background-image:url(/css/images/angular-3_data.png)" alt="Formularios, tablas y modelos de datos en Angular" class="thumbnail-image"></span></a></div><div class="item-inner"><p class="item-category"><a class="article-category-link" href="/categories/Tutorial/">Tutorial</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Tutorial/Angular/">Angular</a></p><p class="item-title"><a href="/formularios-tablas-y-modelos-de-datos-en-angular/" class="title">Formularios, tablas y modelos de datos en Angular</a></p><p class="item-date"><time datetime="2018-08-29T17:17:37.000Z" itemprop="datePublished">29-08-2018</time></p></div></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Categorias</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Avanzado/">Avanzado</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Introduccion/">Introducción</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Opinion/">Opinión</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tutorial/">Tutorial</a><span class="category-list-count">9</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Tutorial/Angular/">Angular</a><span class="category-list-count">9</span></li></ul></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Nube de etiquetas</h3><div class="widget tagcloud"><a href="/tag/Angular/" style="font-size:16.67px">Angular</a> <a href="/tag/Angular2/" style="font-size:20px">Angular2</a> <a href="/tag/Angular5/" style="font-size:16.67px">Angular5</a> <a href="/tag/Angular6/" style="font-size:16.67px">Angular6</a> <a href="/tag/AngularJS/" style="font-size:13.33px">AngularJS</a> <a href="/tag/BackEnd/" style="font-size:10px">BackEnd</a> <a href="/tag/Bootstrap/" style="font-size:11.67px">Bootstrap</a> <a href="/tag/CLI/" style="font-size:15px">CLI</a> <a href="/tag/Components/" style="font-size:10px">Components</a> <a href="/tag/DI/" style="font-size:11.67px">DI</a> <a href="/tag/Forms/" style="font-size:13.33px">Forms</a> <a href="/tag/FrontEnd/" style="font-size:10px">FrontEnd</a> <a href="/tag/Introduccion/" style="font-size:16.67px">Introducción</a> <a href="/tag/MongoDB/" style="font-size:11.67px">MongoDB</a> <a href="/tag/NodeJS/" style="font-size:15px">NodeJS</a> <a href="/tag/Observables/" style="font-size:11.67px">Observables</a> <a href="/tag/Routing/" style="font-size:10px">Routing</a> <a href="/tag/RxJS/" style="font-size:10px">RxJS</a> <a href="/tag/SPA/" style="font-size:11.67px">SPA</a> <a href="/tag/Servicios/" style="font-size:10px">Servicios</a> <a href="/tag/Tutorial/" style="font-size:18.33px">Tutorial</a> <a href="/tag/TypeScript/" style="font-size:10px">TypeScript</a> <a href="/tag/http/" style="font-size:13.33px">http</a> <a href="/tag/reactiveForms/" style="font-size:10px">reactiveForms</a></div></div><div class="widget-wrap widget-list"><h3 class="widget-title">Links</h3><div class="widget"><ul><li><a href="http://atlanticbootcamp.com">Atlantic Bootcamp</a></li><li><a href="http://agorabinaria.com">Ágora Binaria</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Archivos</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">septiembre 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">agosto 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">mayo 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">marzo 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">septiembre 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">junio 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">mayo 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">abril 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">marzo 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">enero 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">noviembre 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">agosto 2015</a><span class="archive-list-count">4</span></li></ul></div></div><div id="toTop" class="fa fa-angle-up"></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2018 Developed by <a target="_blank" href="http://agorabinaria.com">Ágora Binaria</a>.</div></div></footer><script>var disqus_config=function(){this.page.url="https://academia-binaria.com/vigilancia-y-seguridad-en-Angular/",this.page.identifier="vigilancia-y-seguridad-en-Angular"};!function(){var a=document,i=a.createElement("script");i.src="//academiabinaria.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(a.head||a.body).appendChild(i)}()</script><script src="/js/main.js"></script><script src="//load.sumome.com/" data-sumo-site-id="24f3eb649e85fa1f7db20b7fa344f42f381f65f8f86f7028766c55d313e73eb5" async></script></div></body>